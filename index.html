<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> فصل المتميزين v5.1</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NEW: Load Inter font (cleaner than Poppins for UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Load Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <!-- Load qrcode.js for QR code generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- NEW: Confetti library for positive reinforcement -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- NEW: UI/UX Overhaul --- */
        /* 1. New Color Palette (Indigo primary, Green for success) */
        :root {
            --color-primary-500: #6366F1; /* Indigo 500 */
            --color-primary-600: #4F46E5; /* Indigo 600 */
            --color-primary-700: #4338CA; /* Indigo 700 */
            
            /* NEW: Use a slightly different shade for undo button */
            --color-action: #4F46E5; /* Indigo 600 */ 
            
            --color-primary-900: #312E81; /* Indigo 900 */
            
            --color-secondary: #FDE047; /* Yellow 300 */
            
            --color-success: #10B981; /* Green 500 */
            --color-warn: #F59E0B; /* Amber 500 */
            --color-danger: #EF4444; /* Red 500 */

            --color-gradient: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-secondary) 100%);
        }
        
        [data-theme="light"] {
            --bg-color: #f4f5f7; /* Lighter gray */
            --text-color: #111827;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --header-bg: linear-gradient(135deg, var(--color-primary-700) 0%, var(--color-primary-500) 100%);
            --notify-success: var(--color-success);
            --notify-error: var(--color-danger);
            --notify-info: #3B82F6;
        }
        [data-theme="dark"] {
            --bg-color: #111827; /* Dark blue-gray */
            --text-color: #f3f4f6;
            --card-bg: #1f2937; /* Lighter blue-gray */
            --card-border: #374151;
            --header-bg: linear-gradient(135deg, #0f172a 0%, var(--color-primary-900) 100%);
            --notify-success: #34D399;
            --notify-error: #F87171;
            --notify-info: #60A5FA;
        }
        
        html { scroll-behavior: smooth; }
        
        /* 2. New Font */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .bg-gradient-primary {
            background: var(--header-bg);
        }
        .text-gradient {
            background: var(--color-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* 3. Glassmorphism for Modals */
        #modal-backdrop, #billboard-modal-backdrop, #loading-modal-backdrop {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        #modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
        }
        
        /* 4. Card Redesign */
        .requirement-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .requirement-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: var(--color-primary-500);
        }
        
        /* 5. Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb {
            background: var(--color-primary-500);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-600);
        }

        /* 6. Selection Mode Styling */
        .requirement-card.selection-mode {
            cursor: pointer;
            border-color: var(--color-primary-500);
        }
        .requirement-card.selected {
            transform: scale(0.98);
            background-color: var(--color-primary-900);
            border-color: var(--color-primary-500);
        }
        
        /* 7. Subtask Checklist */
        .subtask-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--card-border);
        }
        .subtask-item {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            opacity: 0.8;
            cursor: pointer;
        }
        .subtask-item input {
            margin-left: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 4px;
            color: var(--color-primary-500);
            border-color: var(--card-border);
            background-color: var(--bg-color);
        }
        .subtask-item input:checked {
             border-color: var(--color-primary-500);
        }
        .subtask-item.completed span {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        /* 8. Admin Dashboard Tabs */
        .admin-tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .admin-tab-btn.active {
            background-color: var(--color-primary-600);
            color: white;
        }
        .admin-tab-btn:not(.active) {
            color: var(--text-color);
            opacity: 0.7;
            border: 2px solid var(--card-border);
        }
        .admin-tab-btn:not(.active):hover {
            opacity: 1;
            background-color: var(--card-bg);
        }
        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        
        /* Other styles from original */
        #anti-inspect-overlay {
            position: fixed; top: 0; right: 0; width: 100%; height: 100%;
            background-color: rgba(18, 18, 18, 0.95); color: var(--text-color);
            z-index: 10000; display: none; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            font-size: 1.5rem; padding: 2rem; line-height: 1.5;
        }
        .requirement-card.deleting, section.deleting {
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease, height 0.3s ease, padding 0.3s ease, margin 0.3s ease;
        }
        .requirement-card.deleting { transform: scale(0.95); }
        section.deleting { 
            transform: translateX(-20px); height: 0 !important; padding: 0 !important; margin: 0 !important; overflow: hidden;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-fast { animation: spin 0.5s linear infinite; }
        #qrcode img { margin: 0 auto; }
        .wave-bottom, .wave-top { position: absolute; right: 0; width: 100%; height: auto; color: var(--bg-color); z-index: 10; }
        .wave-bottom { bottom: 0; }
        .wave-top { top: 0; transform: rotate(180deg); }
        .text-accent-secondary { color: var(--color-secondary); }
        #notification-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 1000;
            display: flex; flex-direction: column-reverse; gap: 10px;
        }
        .toast {
            min-width: 250px; max-width: 90vw; background-color: var(--card-bg);
            border-radius: 8px; padding: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%); opacity: 0;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            display: flex; align-items: center; /* Ensure alignment for content and button */
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-right: 4px solid var(--notify-success); }
        .toast.error { border-right: 4px solid var(--notify-error); }
        .toast.info { border-right: 4px solid var(--notify-info); }
        
        /* NEW: Toast Action Button Styling */
        .toast-action-btn {
            background-color: var(--color-action);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 500;
            margin-right: 1rem; /* Space between text and button */
            transition: background-color 0.2s;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .toast-action-btn:hover {
            background-color: var(--color-primary-700);
        }
        
        #file-preview-content {
            max-height: 80vh; overflow-y: auto; background-color: var(--card-bg);
            padding: 1rem; border-radius: 8px; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
            min-height: 100px;
        }
        #file-preview-content img {
            max-width: 100%; max-height: 70vh; width: auto; height: auto;
            border-radius: 8px; object-fit: contain;
        }
        @keyframes progress-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }
        #progress-bar-container {
            height: 12px; border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.1); /* Adjusted opacity */
            overflow: hidden; width: 100%;
        }
        #progress-bar {
            height: 100%; background-color: var(--color-success); /* Use success color */
            background-image: linear-gradient( 45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent );
            background-size: 1rem 1rem;
            transition: width 0.5s ease-in-out;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
            animation: progress-stripes 1s linear infinite;
        }
        #progress-bar {
            height: 100%; background-color: var(--color-success); /* Use success color */
            background-image: linear-gradient( 45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent );
            background-size: 1rem 1rem;
            transition: width 0.5s ease-in-out;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
            animation: progress-stripes 1s linear infinite;
        }
        #go-to-top {
            position: fixed; bottom: 20px; left: 20px; z-index: 100;
            background-color: var(--color-primary-500); color: white; border: none;
            border-radius: 50%; width: 48px; height: 48px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer;
            opacity: 0; transform: translateY(100px);
            transition: opacity 0.3s, transform 0.3s;
        }
        #go-to-top.visible { opacity: 1; transform: translateY(0); }
        #go-to-top:hover { background-color: var(--color-primary-600); }
        .read-more-btn {
            font-size: 0.875rem; font-weight: 600; color: var(--color-primary-500);
            cursor: pointer; transition: color 0.2s;
            display: inline-flex; align-items: center;
        }
        .read-more-btn:hover { color: var(--color-secondary); }
        #billboard-modal-backdrop { z-index: 55; opacity: 0; }
        #billboard-modal-content { padding: 0; overflow: hidden; }
        #billboard-modal-close-btn {
            position: absolute; top: 0.75rem; left: 0.75rem;
            background-color: rgba(0, 0, 0, 0.3); border-radius: 9999px;
            width: 2rem; height: 2rem; display: flex; align-items: center;
            justify-content: center; color: white;
            transition: background-color 0.2s; z-index: 10;
        }
        #billboard-modal-close-btn:hover { background-color: rgba(0, 0, 0, 0.6); }

        /* Floating action button for multi-delete */
        #multi-delete-bar {
            position: fixed;
            bottom: -100px; /* Start hidden */
            left: 50%;
            transform: translateX(-50%);
            z-index: 49; /* Below modals */
            transition: bottom 0.3s ease-in-out;
        }
        #multi-delete-bar.visible {
            bottom: 20px;
        }
        
    </style>
</head>
<body data-theme="dark" class="dark">
    <!-- Anti-Inspect/DevTools Lock Overlay -->
    <div id="anti-inspect-overlay">
        <p class="mb-4">
            <i class="ph ph-lock-key text-5xl text-red-400"></i>
        </p>
        <h2 class="text-3xl font-bold mb-3">تم تفعيل قفل ميزة المسؤول</h2>
        <p class="text-lg">تحظر طبقة ادارة الموقع في هذا التطبيق أدوات الفحص لمنع العبث أو فحص البيانات. يرجى إغلاق أدوات المطور للمتابعة.</p>
    </div>

    <div id="app" class="min-h-screen flex flex-col">

        <!-- Header with Wave SVG -->
        <header id="header" class="relative pb-16 pt-10 sm:pt-16 bg-gradient-primary text-white overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-20">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">
                             فصل المتميزين
                        </h1>
                        <!-- NEW: Personal Welcome Message -->
                        <p id="welcome-message" class="mt-2 text-lg sm:text-xl font-light opacity-90">
                            مركز واحد لجميع تحديثات الصف.
                        </p>
                    </div>
                    
                    <div class="flex flex-col items-start space-y-3 sm:flex-row sm:space-y-0 sm:space-x-3 sm:space-x-reverse">
                        <button id="refresh-button" class="p-3 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition-all focus:outline-none" onclick="fetchJsonBinData(true)">
                            <i id="refresh-icon" class="ph ph-arrows-clockwise text-2xl transition-transform"></i>
                        </button>
                        <button id="qr-toggle" class="p-3 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition-all focus:outline-none" onclick="showQrModal()">
                            <i class="ph ph-qr-code text-2xl"></i>
                        </button>
                        <button id="mode-toggle" class="p-3 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition-all focus:outline-none" onclick="toggleDarkMode()">
                            <i id="mode-icon" class="ph ph-sun text-2xl"></i>
                        </button>
                        <!-- NEW: Profile Button -->
                        <button id="profile-button" class="p-3 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition-all focus:outline-none" onclick="showProfileModal()">
                            <i class="ph ph-user text-2xl"></i>
                        </button>
                        <!-- UPDATED: Admin Button now opens Admin Panel -->
                        <button id="admin-toggle" class="px-4 py-2 rounded-full bg-white text-gray-800 font-semibold hover:bg-gray-200 transition-colors focus:outline-none text-sm shadow-lg" onclick="showAdminPanel()">
                            المسؤول
                        </button>
                    </div>
                </div>
                
                <!-- NEW: Header Quick Stats (Glassmorphism) -->
                <div id="completion-summary" class="mt-8 p-4 rounded-xl bg-black bg-opacity-25 backdrop-blur-sm border border-white border-opacity-20 flex flex-col sm:flex-row items-center justify-between shadow-inner">
                    <!-- Quick Stats -->
                    <div class="w-full flex-1 grid grid-cols-2 sm:grid-cols-4 gap-4 text-center mb-4 sm:mb-0">
                        <div class_A="sm:border-l sm:border-white sm:border-opacity-10 first:border-l-0">
                            <span class="text-xs opacity-70">مهام اليوم</span>
                            <p id="due-today-count" class="text-2xl font-bold text-accent-secondary">0</p>
                        </div>
                        <div class="sm:border-l sm:border-white sm:border-opacity-10">
                            <span class="text-xs opacity-70">مهام متأخرة</span>
                            <p id="overdue-count" class="text-2xl font-bold text-red-400">0</p>
                        </div>
                        <div class="sm:border-l sm:border-white sm:border-opacity-10">
                            <span class="text-xs opacity-70">مهام متبقية</span>
                            <p id="remaining-count" class="text-2xl font-bold">0</p>
                        </div>
                        <div class="sm:border-l sm:border-white sm:border-opacity-10">
                            <span class="text-xs opacity-70">تم الإنجاز</span>
                            <p id="completed-count" class="text-2xl font-bold text-green-400">0</p>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="w-full sm:w-64 sm:mr-6 space-y-2">
                         <div class="flex justify-between text-xs font-medium">
                            <span id="motivational-message" class="opacity-80 italic"></span>
                            <span id="completed-percent">0%</span>
                         </div>
                        <div id="progress-bar-container">
                            <div id="progress-bar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Wave SVG -->
            <svg class="wave-bottom" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" aria-hidden="true">
                <path fill="currentColor" fill-opacity="1" d="M0,192L48,197.3C96,203,192,213,288,208C384,203,480,181,576,170.7C672,160,768,160,864,176C960,192,1056,224,1152,213.3C1248,203,1344,149,1392,122.7L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
            </svg>
        </header>

        <!-- Main Content (Can be hidden for Admin Panel) -->
        <div id="main-content-wrapper">
            <main id="main-content" class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-10">
                
                <!-- NEW: Announcements Section -->
                <section id="announcements-section" class="mb-8">
                    <!-- Title and Admin Add Button -->
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold flex items-center"><i class="ph ph-megaphone-simple ml-2 text-primary-500"></i> إعلانات الفصل</h2>
                        <button id="add-announcement-button" onclick="showAddAnnouncementModal()" class="hidden text-sm font-medium text-primary-500 hover:text-primary-600 flex items-center">
                            <i class="ph ph-plus-circle ml-1"></i> إضافة إعلان
                        </button>
                    </div>
                    <!-- Container for Announcements -->
                    <div id="announcements-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Announcements will be rendered here -->
                    </div>
                </section>
                
                <!-- Search and Filters -->
                 <div class="mb-6 space-y-4">
                     <div class="relative">
                        <input type="text" id="global-search-input" oninput="handleSearchInput()" placeholder="ابحث في جميع المتطلبات بالعنوان أو الوصف..." class="w-full p-3 pr-10 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--card-bg); border-color: var(--card-border);" />
                        <i class="ph ph-magnifying-glass absolute top-1/2 -translate-y-1/2 right-3 text-gray-500"></i>
                     </div>
                     <!-- Quick Filters -->
                     <div class="flex flex-wrap gap-2">
                        <button id="filter-due-today" onclick="toggleDueTodayFilter()" class="px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors bg-secondary-500 text-secondary-900" style="background-color: var(--color-secondary); color: var(--color-primary-900);">
                            <i class="ph ph-calendar-check ml-2"></i>
                            <span id="filter-due-today-text">عرض مهام اليوم فقط</span>
                        </button>
                        <button id="global-archive-toggle" onclick="toggleGlobalArchive()" class="px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
                            <i class="ph ph-archive ml-2"></i>
                            <span id="global-archive-toggle-text">إخفاء الأرشيفات</span>
                        </button>
                        <button id="admin-select-toggle" onclick="toggleSelectMode()" class="hidden px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors bg-blue-600 text-white">
                            <i class="ph ph-check-square-offset ml-2"></i>
                            <span>تفعيل وضع التحديد</span>
                        </button>
                        <button id="add-subject-button" onclick="showAddSubjectModal()" class="hidden px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors bg-green-600 text-white">
                            <i class="ph ph-plus-circle ml-2"></i> إضافة مادة
                        </button>
                     </div>
                 </div>
                 
                 <!-- Subjects Container -->
                 <div id="subjects-container">
                    <!-- Subjects will be rendered here by renderApp() -->
                 </div>
            </main>
        </div>

        <!-- NEW: Admin Dashboard (Hidden by default) -->
        <div id="admin-dashboard" class="hidden flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gradient">لوحة تحكم المسؤول</h2>
                <button onclick="closeAdminPanel()" class="px-4 py-2 rounded-lg text-sm font-medium flex items-center transition-colors" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
                     <i class="ph ph-arrow-right ml-2"></i> العودة للصفحة الرئيسية
                </button>
            </div>
            
            <!-- Admin Tabs -->
            <div class="flex flex-wrap gap-2 mb-6 border-b" style="border-color: var(--card-border);">
                <button class="admin-tab-btn active" onclick="switchAdminTab('tab-subjects')">إدارة المواد</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('tab-announcements')">إدارة الإعلانات</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('tab-billboard')">إدارة الـ Billboard</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('tab-settings')">الإعدادات والأمان</button>
            </div>
            
            <!-- Tab Content -->
            <div id="admin-tab-content" class="space-y-6">
                <!-- Tab 1: Manage Subjects -->
                <div id="tab-subjects" class="admin-tab-content active space-y-4">
                    <h3 class="text-xl font-semibold">المواد الدراسية</h3>
                    <button onclick="showAddSubjectModal()" class="w-full max-w-xs px-4 py-3 rounded-lg text-base font-semibold bg-green-600 hover:bg-green-700 text-white transition-colors shadow-lg flex items-center justify-center">
                        <i class="ph ph-plus-circle ml-2 text-xl"></i> إضافة مادة جديدة
                    </button>
                    <div id="admin-subjects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Subject management cards rendered here -->
                    </div>
                </div>
                
                <!-- Tab 2: Manage Announcements -->
                <div id="tab-announcements" class="admin-tab-content space-y-4">
                    <h3 class="text-xl font-semibold">الإعلانات</h3>
                    <button onclick="showAddAnnouncementModal()" class="w-full max-w-xs px-4 py-3 rounded-lg text-base font-semibold bg-green-600 hover:bg-green-700 text-white transition-colors shadow-lg flex items-center justify-center">
                        <i class="ph ph-plus-circle ml-2 text-xl"></i> إضافة إعلان جديد
                    </button>
                    <div id="admin-announcements-list" class="space-y-3">
                        <!-- Announcement management list rendered here -->
                    </div>
                </div>
                
                <!-- Tab 3: Manage Billboard -->
                <div id="tab-billboard" class="admin-tab-content">
                    <button onclick="showBillboardEditModal()" class="w-full max-w-xs px-4 py-3 rounded-lg text-base font-semibold bg-blue-600 hover:bg-blue-700 text-white transition-colors shadow-lg flex items-center justify-center">
                        <i class="ph ph-speaker-high ml-2 text-xl"></i> تعديل إعلان الـ Billboard
                    </button>
                </div>
                
                <!-- Tab 4: Settings & Security -->
                <div id="tab-settings" class="admin-tab-content grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 rounded-lg space-y-3" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
                        <h3 class="text-lg font-semibold text-yellow-500">تغيير كلمة مرور المسؤول</h3>
                        <button onclick="showChangePasswordModal()" class="w-full px-3 py-2 rounded-lg text-sm font-semibold text-white bg-yellow-600 hover:bg-yellow-700 transition-colors">
                            <i class="ph ph-key ml-1"></i> تغيير كلمة المرور
                        </button>
                    </div>
                    <div class="p-4 rounded-lg space-y-3" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
                        <h3 class="text-lg font-semibold text-red-500">قفل وضع المطور</h3>
                        <p class="text-xs opacity-70">يمنع فحص الصفحة. قد يكون مزعجاً أثناء التطوير.</p>
                        <button id="admin-devtools-toggle" onclick="toggleDevToolsLock()" class="w-full px-3 py-2 rounded-lg text-sm font-semibold text-white">
                            <!-- Text/Color set by JS -->
                        </button>
                    </div>
                     <div class="p-4 rounded-lg space-y-3" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
                        <h3 class="text-lg font-semibold">بيانات الاتصال (للمساعدة)</h3>
                        <p class="text-xs opacity-70">سيتم استخدام هذا البريد الإلكتروني عندما يضغط الطلاب على زر "أحتاج مساعدة؟".</p>
                        <button onclick="showContactEditModal()" class="w-full px-3 py-2 rounded-lg text-sm font-semibold text-white bg-gray-500 hover:bg-gray-600 transition-colors">
                            <i class="ph ph-envelope ml-1"></i> تعديل بريد التواصل
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="relative pt-16 mt-10 bg-gradient-primary text-white overflow-hidden">
            <!-- Wave SVG (Inverted for footer) -->
            <svg class="wave-top" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" aria-hidden="true">
                <path fill="currentColor" fill-opacity="1" d="M0,192L48,197.3C96,203,192,213,288,208C384,203,480,181,576,170.7C672,160,768,160,864,176C960,192,1056,224,1152,213.3C1248,203,1344,149,1392,122.7L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
            </svg>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 relative z-20 text-center">
                <p class="text-sm opacity-80">
                    <span class="mr-4">CS v5.1 (Undo Feature)</span>
                    <span id="last-updated-display" class="mr-4"></span>
                </p>
                <p class="text-xs opacity-70 mt-1">
                    تم تطويره من قبل زياد | حالة الإنجاز النهائي: <span id="footer-completion-status">0%</span>
                </p>
            </div>
        </footer>

        <!-- Generic Modal Structure -->
        <div id="modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-50">
            <div id="modal-content" class="p-6 rounded-xl shadow-2xl w-full max-w-md mx-4 transition-all scale-95 opacity-0 duration-300">
                <!-- Modal content will be injected here -->
            </div>
        </div>
        
        <!-- Loading Modal -->
        <div id="loading-modal-backdrop" class="fixed inset-0 hidden items-center justify-center z-[60]">
            <div class="p-8 rounded-xl shadow-2xl flex flex-col items-center" style="background-color: var(--card-bg);">
                <div class="w-6 h-6 rounded-full animate-spin-fast" style="border: 4px solid var(--color-primary-500); border-top-color: transparent;"></div>
                <p id="loading-message" class="mt-4 text-lg">جارٍ جلب البيانات...</p>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notification-container"></div>
        
        <!-- Go to Top Button -->
        <button id="go-to-top" onclick="window.scrollTo(0, 0)">
            <i class="ph ph-arrow-up text-2xl"></i>
        </button>

        <!-- Billboard Modal -->
        <div id="billboard-modal-backdrop" class="fixed inset-0 hidden items-center justify-center transition-opacity duration-300">
            <div id="billboard-modal-content" class="relative rounded-xl shadow-2xl w-full max-w-md mx-4 transition-all scale-95 opacity-0 duration-300" style="background-color: var(--card-bg);">
                <!-- Billboard Content will be injected here -->
            </div>
        </div>
        
        <!-- NEW: Multi-Delete Floating Bar -->
        <div id="multi-delete-bar" class="p-3 rounded-xl shadow-lg flex items-center gap-4" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
            <span id="selection-count" class="text-sm font-medium">تم تحديد 0 عنصر</span>
            <button onclick="deleteSelectedItems()" class="px-4 py-2 rounded-lg text-sm font-medium bg-red-600 hover:bg-red-700 text-white flex items-center">
                <i class="ph ph-trash ml-2"></i> حذف المحدد
            </button>
            <button onclick="toggleSelectMode()" class="p-2 rounded-full hover:bg-gray-700">
                <i class="ph ph-x text-lg"></i>
            </button>
        </div>

    </div>

    <script>
        // --- GLOBAL CONFIG & INITIALIZATION ---
        
        // --- JSONBIN.IO CONFIGURATION ---
        const JSONBIN_ID = "68fa19f543b1c97be97a746a";
        const JSONBIN_SECRET_KEY = "$2a$10$OgesEl/ryBSJSZP6gf4Z3ecX20iq2yJoA6tEraNsO/UvPGhG1.29S";
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;

        const POLLING_INTERVAL = 60000; 
        let SUBJECTS = [];
        
        // --- UPDATED: Schema version for cache invalidation ---
        const SCHEMA_VERSION = "5.1";
        
        // --- Local Storage Keys ---
        const getLSKey = (key) => `${JSONBIN_ID}_${key}`;
        const COMPLETED_ITEMS_KEY = getLSKey("crp_completed_items");
        const THEME_KEY = getLSKey("crp_theme");
        const FILTER_KEY_PREFIX = getLSKey("crp_filter_");
        const ARCHIVE_KEY_PREFIX = getLSKey("crp_archive_visible_");
        const GLOBAL_ARCHIVE_KEY = getLSKey("crp_global_archive_hidden"); 
        const DEV_LOCK_KEY = getLSKey("crp_devtools_lock_enabled");
        const CACHE_KEY = getLSKey("crp_data_cache");
        const BILLBOARD_SEEN_KEY = getLSKey("crp_billboard_seen_session");
        const SCHEMA_VERSION_KEY = getLSKey("crp_schema_version");
        const NICKNAME_KEY = getLSKey("crp_nickname"); 
        const SUBTASKS_KEY = getLSKey("crp_subtasks"); 

        // --- Task Types ---
        const TYPE_MAP = {
            'homework': 'واجب منزلي', 'exam': 'اختبار', 'research': 'بحث', 
            'brochure': 'مطوية', 'link': 'رابط / ملف', 'note': 'ملاحظة'
        };
        
        // --- NEW: Priority Types ---
        const PRIORITY_MAP = {
            'low': { text: 'منخفض', color: 'bg-gray-500 text-white' },
            'normal': { text: 'عادي', color: 'bg-blue-500 text-white' },
            'high': { text: 'عاجل', color: 'bg-red-600 text-white' }
        };

        // --- Global State ---
        let currentData = null;
        let isDarkMode = true;
        let isAdmin = false;
        let currentFilters = {}; 
        let lastKnownDataHash = null;
        let isInitialLoad = true;
        let lastUpdateTime = null;
        let searchTimeout = null;
        const DEBOUNCE_DELAY = 300; 
        const TRUNCATE_LENGTH = 100;
        const NEW_BADGE_HOURS = 48;
        
        // --- State for new features ---
        let userNickname = '';
        let isSelectMode = false; // For multi-delete
        let selectedItems = new Set(); // For multi-delete
        let isDueTodayFilterActive = false; // For due today filter
        
        // --- NEW: Undo Feature State ---
        let completionTimer = null;
        let pendingCompletionItemId = null;
        const UNDO_TIMEOUT_MS = 5000; // 5 seconds for undo

        // --- Initial MVP Data Structure (Kept for fallback) ---
        const MVP_DATA = {
            "subjects": {
                "الرياضيات": [
                  {
                    "title": "واجب منزلي: ورقة عمل الجبر", "description": "حل جميع التمارين في الصفحات 32–35.",
                    "due_date": "2025-10-30", "type": "homework", "file": "https://placehold.co/600x400/6366F1/FFFFFF?text=Homework+Sheet", 
                    "pinned": true, "id": "math-1", "file_display_name": "ورقة عمل الجبر (رابط)",
                    "created_at": "2025-10-28T10:00:00.000Z",
                    "priority": "normal", 
                    "subtasks": ["حل صفحة 32", "حل صفحة 33-35"] 
                  },
                  {
                    "title": "اختبار قصير: الدوال المثلثية", "description": "الاستعداد للاختبار القصير في نهاية الأسبوع.",
                    "due_date": "2025-10-25", "type": "exam", "file": "", "pinned": false, "id": "math-2",
                    "file_display_name": "", "created_at": "2025-10-20T10:00:00.000Z",
                    "priority": "high", "subtasks": []
                  }
                ]
            },
            // NEW: Announcements structure
            "announcements": [
                { "id": "anno-1", "title": "تذكير هام بخصوص الاختبارات", "description": "يرجى مراجعة جدول الاختبارات النهائي الذي تم إرساله والتأكد من استعدادكم.", "created_at": "2025-10-25T10:00:00.000Z" }
            ],
            "meta": {
                "version": "1.0",
                "admin_pass": "PLEASE_SET_A_PASSWORD",
                "schema_version": SCHEMA_VERSION, 
                "contact_email": "teacher@example.com" 
            },
            "billboard": {
                "isEnabled": true, "title": "ترحيب! تحديثات فصل المتميزين",
                "imageURL": "https://placehold.co/600x400/4F46E5/FFFFFF?text=Welcome+Announcement",
                "bodyText": "مرحبًا بكم في نظام تتبع المتطلبات الجديد! هذا النظام مصمم لتبسيط إدارة المهام والواجبات والاختبارات.",
                "buttonText": "ابدأ التصفح", "linkURL": ""
            }
        };

        // --- JSONBIN UTILITIES ---
        
        function hashData(data) {
             return JSON.stringify(data).length;
        }
        
        function setRefreshState(isLoading) {
            const icon = document.getElementById('refresh-icon');
            if (icon) {
                icon.classList.toggle('animate-spin-fast', isLoading);
            }
        }

        async function fetchJsonBinData(isManualRefresh = false) {
            if (JSONBIN_ID === "YOUR_JSONBIN_ID" || JSONBIN_SECRET_KEY === "") {
                console.error("JSONBIN_ID or Secret Key is not set. Using MVP data.");
                if (isInitialLoad) processNewData(MVP_DATA);
                isInitialLoad = false;
                return;
            }
            
            if (isInitialLoad || isManualRefresh) {
                showLoadingModal(isManualRefresh ? 'جاري تحديث البيانات...' : 'جارٍ جلب البيانات من الخادم...');
            }
            if (isManualRefresh) setRefreshState(true);

            try {
                const response = await fetch(JSONBIN_URL + '/latest', {
                    headers: {
                        'X-Master-Key': JSONBIN_SECRET_KEY, 'X-Bin-Meta': 'false',
                        'Cache-Control': 'no-cache', 'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                const dataHash = hashData(data);
                
                if (dataHash === lastKnownDataHash && !isInitialLoad && !isManualRefresh) {
                    console.log("JSONBin: Data unchanged.");
                    return;
                }
                
                lastKnownDataHash = dataHash;
                lastUpdateTime = new Date().toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' });
                
                try { localStorage.setItem(CACHE_KEY, JSON.stringify(data)); } 
                catch (e) { console.warn("Could not write to localStorage cache:", e); }
                
                processNewData(data); 

                if (isManualRefresh) {
                    showNotification("تم تحديث البيانات بنجاح.", "success", 2000);
                }
                
            } catch (error) {
                console.error("JSONBin Fetch Error (using previous/MVP data as fallback):", error);
                if (isManualRefresh) {
                    showNotification("فشل تحديث البيانات. يرجى المحاولة مرة أخرى.", "error");
                }
                if (isInitialLoad && !currentData) { 
                    processNewData(MVP_DATA);
                }
            } finally {
                if (isInitialLoad || isManualRefresh) {
                    hideLoadingModal();
                    setRefreshState(false);
                    isInitialLoad = false;
                }
            }
        }
        
        /**
         * Processes new data (from fetch or cache) and renders the app.
         * @param {object} data The data object to process.
         */
        function processNewData(data) {
            // --- NEW: Schema Version Check ---
            // Must run *before* processing data
            checkSchemaVersion(data?.meta?.schema_version);

            // --- Data Integrity Checks ---
            if (!data.meta) data.meta = { ...MVP_DATA.meta, ...data.meta };
            if (!data.meta.admin_pass) data.meta.admin_pass = MVP_DATA.meta.admin_pass;
            if (!data.meta.schema_version) data.meta.schema_version = MVP_DATA.meta.schema_version;
            if (!data.meta.contact_email) data.meta.contact_email = MVP_DATA.meta.contact_email;
            if (!data.subjects) data.subjects = MVP_DATA.subjects;
            if (!data.billboard) data.billboard = MVP_DATA.billboard;
            if (!data.announcements) data.announcements = MVP_DATA.announcements; 
            
            currentData = data;
            SUBJECTS = Object.keys(currentData.subjects);

            loadSavedFilters();
            
            // --- Data Migration / Fallbacks ---
            for (const subject in currentData.subjects) {
                currentData.subjects[subject] = currentData.subjects[subject].map(item => {
                    if (item.file && !item.file_display_name) {
                        item.file_display_name = getFileDisplayInfo(item.file).displayName || 'ملف مرفق';
                    }
                    // Add new fields if missing
                    if (!item.priority) item.priority = 'normal';
                    if (!item.subtasks) item.subtasks = [];
                    return item;
                });
            }
            
            renderApp();
            
            // Show billboard (if enabled)
            if (currentData.billboard && currentData.billboard.isEnabled) {
                setTimeout(() => showBillboardModal(currentData.billboard), 1500);
            }
        }


        async function updateJsonBinData(data) {
            if (JSONBIN_ID === "YOUR_JSONBIN_ID" || JSONBIN_SECRET_KEY === "") {
                 console.error("JSONBIN_ID or Secret Key is not set. Data not saved.");
                 showNotification("فشل حفظ البيانات. يرجى التحقق من مفتاح JSONBin.", "error");
                 return;
            }
            
            // --- NEW: Ensure schema version is always attached ---
            if (data.meta) {
                data.meta.schema_version = SCHEMA_VERSION;
            }
            
            showLoadingModal("جاري حفظ التغييرات...");
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_SECRET_KEY },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const dataHash = hashData(data);
                lastKnownDataHash = dataHash;
                lastUpdateTime = new Date().toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' });
                
                try { localStorage.setItem(CACHE_KEY, JSON.stringify(data)); } 
                catch (e) { console.warn("Could not write to localStorage cache after update:", e); }
                
                showNotification("تم حفظ البيانات بنجاح.", "success");
                renderApp(); // Force re-render after successful push
            } catch (error) {
                console.error("JSONBin Update Error:", error);
                showNotification("فشل حفظ البيانات. يرجى التحقق من المفتاح السري ومعرف البين.", "error");
                showNotification("فشل الحفظ. جاري إعادة المزامنة مع الخادم...", "info");
                fetchJsonBinData(true);
            } finally {
                hideLoadingModal();
            }
        }

        // --- APP INITIALIZATION ---

        function startPolling() {
            fetchJsonBinData(); 
            setInterval(fetchJsonBinData, POLLING_INTERVAL);
        }

        function initScrollListener() {
            const goToTopButton = document.getElementById('go-to-top');
            window.addEventListener('scroll', () => {
                goToTopButton.classList.toggle('visible', window.scrollY > 300);
            }, { passive: true });
        }

        // --- NEW: Schema Version Check ---
        function checkSchemaVersion(fetchedVersion) {
            const localVersion = localStorage.getItem(SCHEMA_VERSION_KEY);
            const targetVersion = fetchedVersion || SCHEMA_VERSION; // Use fetched if available
            
            if (localVersion !== targetVersion) {
                console.warn(`Schema version mismatch! Local: ${localVersion}, Fetched: ${targetVersion}. Clearing local storage.`);
                showNotification("تم تحديث التطبيق! جاري مسح ذاكرة التخزين المؤقت القديمة.", "info", 4000);
                
                // Clear all keys associated with this app
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(JSONBIN_ID)) {
                        localStorage.removeItem(key);
                    }
                });
                
                // Set the new version
                localStorage.setItem(SCHEMA_VERSION_KEY, targetVersion);
            }
        }

        function initApp() {
            console.warn(
                "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n" +
                "!!!                تنبيه أمني خطير جداً                  !!!\n" +
                "Your JSONBIN_SECRET_KEY is exposed client-side. This is NOT secure.\n" +
                "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
            );

            // Load theme
            const savedTheme = localStorage.getItem(THEME_KEY);
            isDarkMode = savedTheme ? savedTheme === 'dark' : true;
            document.body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            document.body.classList.toggle('dark', isDarkMode);
            document.getElementById('mode-icon').classList.add(isDarkMode ? 'ph-sun' : 'ph-moon');
            
            // Load Nickname
            userNickname = localStorage.getItem(NICKNAME_KEY) || '';
            updateWelcomeMessage();
            
            updateGlobalArchiveToggleUI();
            initScrollListener();

            // Load from cache first
            try {
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (cachedData) {
                    console.log("Loading data from local cache...");
                    const data = JSON.parse(cachedData);
                    lastKnownDataHash = hashData(data);
                    processNewData(data);
                    isInitialLoad = false;
                }
            } catch (e) {
                console.error("Could not read from cache:", e);
                localStorage.removeItem(CACHE_KEY);
            }
            
            startPolling();
        }

        // --- LOCAL STORAGE UTILITIES ---
        
        function loadSavedFilters() {
            SUBJECTS.forEach(subjectName => {
                const savedFilter = localStorage.getItem(FILTER_KEY_PREFIX + subjectName);
                if (savedFilter) currentFilters[subjectName] = savedFilter;
            });
        }
        
        function getLocalStorageSet(key) {
            try {
                const stored = localStorage.getItem(key);
                return stored ? new Set(JSON.parse(stored)) : new Set();
            } catch (e) {
                console.error(`Error reading ${key}:`, e);
                return new Set();
            }
        }
        
        function setLocalStorageSet(key, set) {
             try {
                localStorage.setItem(key, JSON.stringify(Array.from(set)));
                return true;
            } catch (e) {
                console.error(`Error writing ${key}:`, e);
                return false;
            }
        }
        
        // --- NEW: Subtask Storage ---
        function getSubtaskMap() {
             try {
                const stored = localStorage.getItem(SUBTASKS_KEY);
                return stored ? JSON.parse(stored) : {}; // Returns an object like { "item-id": [0, 2] }
            } catch (e) {
                console.error("Error reading subtasks:", e);
                return {};
            }
        }
        
        window.toggleSubtask = function(itemId, subtaskIndex) {
            const subtaskMap = getSubtaskMap();
            if (!subtaskMap[itemId]) {
                subtaskMap[itemId] = [];
            }
            
            const indexSet = new Set(subtaskMap[itemId]);
            if (indexSet.has(subtaskIndex)) {
                indexSet.delete(subtaskIndex);
            } else {
                indexSet.add(subtaskIndex);
            }
            subtaskMap[itemId] = Array.from(indexSet);
            
            try {
                localStorage.setItem(SUBTASKS_KEY, JSON.stringify(subtaskMap));
            } catch (e) {
                showNotification("فشل حفظ حالة المهمة الفرعية.", "error");
            }
            
            // Re-render just this card's subtasks and main button
            const card = document.getElementById(`card-${itemId}`);
            if (card) {
                const item = findItem(itemId);
                if (item) {
                    const listEl = card.querySelector('.subtask-list');
                    const mainCheckEl = card.querySelector('.main-task-checkbox');
                    if (listEl) listEl.innerHTML = renderSubtasks(item.item, subtaskMap);
                    if (mainCheckEl) {
                         const allDone = (item.item.subtasks.length > 0) && (subtaskMap[itemId]?.length === item.item.subtasks.length);
                         mainCheckEl.disabled = !allDone && (item.item.subtasks.length > 0);
                         // If we disable it, ensure it's unchecked if it was previously marked as complete 
                         if (mainCheckEl.disabled && mainCheckEl.checked) {
                             mainCheckEl.checked = false;
                             // Force state update since user is undoing completion by un-checking a subtask
                             // We immediately commit the un-completion to localStorage to avoid confusion.
                             forceToggleCompleted(itemId, false, false);
                         }
                    }
                }
            }
            renderApp(); // Rerender to update stats
        }
        
        // --- Completion Logic ---
        function getCompletedItems() { return getLocalStorageSet(COMPLETED_ITEMS_KEY); }
        
        /**
         * Forces a change in completion state immediately and updates localStorage.
         * Used for subtask logic or immediate undo/redo actions.
         * @param {string} itemId The item ID.
         * @param {boolean} isCompleted The new state (true for completed, false for incomplete).
         * @param {boolean} shouldRerender If true, calls renderApp(). Defaults to true.
         */
        function forceToggleCompleted(itemId, isCompleted, shouldRerender = true) {
            const completedItems = getCompletedItems();
            
            if (isCompleted) {
                completedItems.add(itemId);
            } else {
                completedItems.delete(itemId);
                // When un-completing, clear subtask progress for clarity
                const subtaskMap = getSubtaskMap();
                if (subtaskMap[itemId]) {
                     delete subtaskMap[itemId];
                     localStorage.setItem(SUBTASKS_KEY, JSON.stringify(subtaskMap));
                }
            }
            setLocalStorageSet(COMPLETED_ITEMS_KEY, completedItems);
            if (shouldRerender) renderApp();
        }

        /**
         * Toggles the completion state with a temporary state for undo functionality.
         * @param {string} itemId The item ID.
         */
        window.toggleCompleted = function(itemId) {
            // 1. Clear any existing timer/pending state
            clearTimeout(completionTimer);
            pendingCompletionItemId = null;

            const completedItems = getCompletedItems();
            const wasCompleted = completedItems.has(itemId);

            if (wasCompleted) {
                // If un-checking, execute immediately (no undo needed for un-completion)
                forceToggleCompleted(itemId, false);
                showNotification("تم إلغاء إنجاز المتطلب.", "info", 2000);
            } else {
                // If completing, initiate the pending state
                
                // a. Immediately update UI (Visual feedback)
                forceToggleCompleted(itemId, true, false); // Update UI without fully committing to localStorage yet
                renderApp();
                launchConfetti();

                // b. Set pending state
                pendingCompletionItemId = itemId;
                
                // c. Start timer to commit to localStorage if no undo is performed
                completionTimer = setTimeout(() => {
                    if (pendingCompletionItemId === itemId) {
                        // Time elapsed, commit to permanent localStorage
                        forceToggleCompleted(itemId, true);
                        showNotification("تم حفظ حالة الإنجاز بشكل دائم.", "success", 2000);
                        pendingCompletionItemId = null;
                    }
                }, UNDO_TIMEOUT_MS);
                
                // d. Show notification with Undo action
                showNotification(`تم إنجاز المتطلب! لديك ${UNDO_TIMEOUT_MS/1000} ثوانٍ للتراجع.`, "success", UNDO_TIMEOUT_MS, "تراجع", `undoCompletion('${itemId}')`);
            }
        }
        
        /**
         * Reverts the pending completion state.
         * @param {string} itemId The item ID to revert.
         */
        window.undoCompletion = function(itemId) {
            if (pendingCompletionItemId === itemId) {
                clearTimeout(completionTimer);
                pendingCompletionItemId = null;
                
                // Revert UI state (force to incomplete state)
                forceToggleCompleted(itemId, false);
                
                showNotification("تم التراجع عن إنجاز المتطلب.", "info", 2000);
            }
        }
        
        // --- NEW: Confetti ---
        function launchConfetti() {
            if (window.confetti) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        // --- Archive Logic ---
        function updateGlobalArchiveToggleUI() {
            const isHidden = localStorage.getItem(GLOBAL_ARCHIVE_KEY) === 'true';
            const buttonText = document.getElementById('global-archive-toggle-text');
            if (buttonText) {
                buttonText.textContent = isHidden ? 'عرض الأرشيفات' : 'إخفاء الأرشيفات';
            }
        }
        
        window.toggleGlobalArchive = function() {
            const isHidden = localStorage.getItem(GLOBAL_ARCHIVE_KEY) === 'true';
            localStorage.setItem(GLOBAL_ARCHIVE_KEY, isHidden ? 'false' : 'true');
            updateGlobalArchiveToggleUI();
            renderApp();
        }

        window.toggleArchiveVisibility = function(subjectName) {
            const key = ARCHIVE_KEY_PREFIX + subjectName;
            const isVisible = localStorage.getItem(key) !== 'false';
            localStorage.setItem(key, isVisible ? 'false' : 'true');
            renderApp();
        }
        
        // --- NEW: Profile / Nickname ---
        function updateWelcomeMessage() {
            const msgEl = document.getElementById('welcome-message');
            if (!msgEl) return;
            userNickname = localStorage.getItem(NICKNAME_KEY) || '';
            if (userNickname) {
                msgEl.textContent = `مرحباً يا ${userNickname}، إليك تحديثات صفك.`;
            } else {
                msgEl.textContent = "مركز واحد لجميع تحديثات الصف.";
            }
        }
        
        window.showProfileModal = function() {
             document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">ملفك الشخصي</h2>
                <p class="text-sm opacity-80 mb-4">يتم حفظ اسمك المستعار على هذا الجهاز فقط.</p>
                <label for="nickname-input" class="block text-sm font-medium mb-1">اسمك المستعار (اختياري)</label>
                <input type="text" id="nickname-input" value="${userNickname}" placeholder="مثال: فلان" class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                
                <div class="mt-6 flex justify-start space-x-3 space-x-reverse">
                    <button onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إلغاء</button>
                    <button onclick="saveNickname()" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">حفظ</button>
                </div>
            `;
            showModal();
        }
        
        window.saveNickname = function() {
            userNickname = document.getElementById('nickname-input').value.trim();
            localStorage.setItem(NICKNAME_KEY, userNickname);
            updateWelcomeMessage();
            showNotification("تم حفظ الاسم المستعار!", "success", 2000);
            closeModal();
        }


        // --- FILTERING LOGIC ---
        
        // NEW: Due Today Filter
        window.toggleDueTodayFilter = function() {
            isDueTodayFilterActive = !isDueTodayFilterActive;
            const btn = document.getElementById('filter-due-today');
            const btnText = document.getElementById('filter-due-today-text');
            
            if (isDueTodayFilterActive) {
                btn.style.backgroundColor = 'var(--color-primary-600)';
                btn.style.color = 'white';
                btnText.textContent = 'عرض جميع المهام';
            } else {
                btn.style.backgroundColor = 'var(--color-secondary)';
                btn.style.color = 'var(--color-primary-900)';
                btnText.textContent = 'عرض مهام اليوم فقط';
            }
            renderApp();
        }

        window.setFilter = function(subjectName, filterType) {
            if (currentFilters[subjectName] === filterType || filterType === 'reset') {
                delete currentFilters[subjectName];
                localStorage.removeItem(FILTER_KEY_PREFIX + subjectName);
            } else {
                currentFilters[subjectName] = filterType;
                localStorage.setItem(FILTER_KEY_PREFIX + subjectName, filterType);
            }
            renderApp();
        }

        window.handleSearchInput = function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(renderApp, DEBOUNCE_DELAY);
        }


        // --- UI RENDERING FUNCTIONS ---

        function getIconForType(type) {
            switch (type) {
                case 'homework': return `<i class="ph ph-note-pencil text-xl text-yellow-400"></i>`;
                case 'exam': return `<i class="ph ph-book-open-text text-xl text-red-500"></i>`;
                case 'research': return `<i class="ph ph-magnifying-glass text-xl text-cyan-400"></i>`;
                case 'brochure': return `<i class="ph ph-article text-xl text-pink-400"></i>`;
                case 'link': return `<i class="ph ph-link text-xl text-green-400"></i>`;
                default: return `<i class="ph ph-info text-xl text-gray-400"></i>`;
            }
        }
        
        function getFileDisplayInfo(fileUrl) {
            if (!fileUrl) return { displayName: '', icon: '' };
            const lowerUrl = fileUrl.toLowerCase();
            if (lowerUrl.includes('.pdf')) return { displayName: 'مستند PDF', icon: '<i class="ph ph-file-pdf text-xs ml-1"></i>' };
            if (lowerUrl.includes('.zip') || lowerUrl.includes('.rar')) return { displayName: 'أرشيف مضغوط', icon: '<i class="ph ph-archive-box text-xs ml-1"></i>' };
            if (lowerUrl.match(/\.(png|jpg|jpeg|gif|webp)$/)) return { displayName: 'صورة', icon: '<i class="ph ph-image text-xs ml-1"></i>' };
            if (lowerUrl.match(/\.(doc|docx)$/)) return { displayName: 'مستند Word', icon: '<i class="ph ph-file-doc text-xs ml-1"></i>' };
            if (lowerUrl.startsWith('http')) return { displayName: 'رابط خارجي', icon: '<i class="ph ph-globe-simple text-xs ml-1"></i>' };
            return { displayName: 'رابط/ملف', icon: '<i class="ph ph-file text-xs ml-1"></i>' };
        }
        
        // Date Helpers
        function getToday() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }
        
        function parseDate(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function isDuePast(date) { return date && date < getToday(); }
        function isDueToday(date) { return date && date.getTime() === getToday().getTime(); }
        
        function formatDueDate(dateString) {
            const date = parseDate(dateString);
            if (!date) return { text: '', class: 'text-gray-400' };

            if (isDuePast(date)) {
                return { text: 'فات الموعد', class: 'text-red-500 font-bold' };
            }
            if (isDueToday(date)) {
                return { text: 'يستحق اليوم', class: 'text-yellow-500 font-bold' };
            }
            
            const diffTime = date.getTime() - getToday().getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
                return { text: 'يستحق غداً', class: 'text-yellow-500' };
            }
            
            const dateText = date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
            return { text: `يستحق: ${dateText}`, class: 'text-gray-400' };
        }
        
        // Find an item by ID across all subjects
        function findItem(itemId) {
            if (!currentData || !currentData.subjects) return null;
            for (const subjectName of SUBJECTS) {
                const item = currentData.subjects[subjectName].find(i => i.id === itemId);
                if (item) return { subjectName, item };
            }
            return null;
        }

        // --- NEW: Render Subtasks ---
        function renderSubtasks(item, subtaskMap) {
            if (!item.subtasks || item.subtasks.length === 0) return '';
            
            const completedSubtasks = new Set(subtaskMap[item.id] || []);
            
            return item.subtasks.map((task, index) => {
                const isCompleted = completedSubtasks.has(index);
                return `
                    <label class="subtask-item ${isCompleted ? 'completed' : ''}" for="subtask-${item.id}-${index}">
                        <input type="checkbox" id="subtask-${item.id}-${index}" 
                               onchange="toggleSubtask('${item.id}', ${index})" 
                               ${isCompleted ? 'checked' : ''}
                               class="focus:ring-primary-500">
                        <span>${task}</span>
                    </label>
                `;
            }).join('');
        }

        function renderRequirementCard(subjectName, item, isArchived = false) {
            const dueDate = formatDueDate(item.due_date);
            const fileInfo = getFileDisplayInfo(item.file);
            const fileDisplayName = item.file_display_name || fileInfo.displayName || 'ملف مرفق';
            
            let fileElement = '';
            if (item.file) {
                 fileElement = `
                    <button onclick="showFilePreviewModal('${subjectName}', '${item.id}')" 
                            class="text-xs text-primary-500 hover:text-primary-400 font-semibold truncate flex items-center p-1 -m-1 rounded hover:bg-gray-700 transition-colors">
                        ${fileInfo.icon} 
                        <span>${fileDisplayName}</span>
                    </button>
                `;
            }

            // Description Truncation
            let descriptionHtml = '';
            if (item.description.length > TRUNCATE_LENGTH) {
                const truncatedDesc = item.description.substring(0, TRUNCATE_LENGTH) + '... ';
                descriptionHtml = `
                    <p class="mt-2 text-sm opacity-70" id="desc-${item.id}">
                        ${truncatedDesc}
                        <button id="btn-${item.id}" data-expanded="false" class="read-more-btn" onclick="toggleDescription('${subjectName}', '${item.id}')">...أكثر <i class="ph ph-caret-down mr-1"></i></button>
                    </p>
                `;
            } else {
                descriptionHtml = `<p class="mt-2 text-sm opacity-70">${item.description}</p>`;
            }

            const completedItems = getCompletedItems();
            const isCompleted = completedItems.has(item.id);
            const cardOpacity = isCompleted && !isAdmin ? 'opacity-50' : '';

            // --- Badges ---
            let isNew = false;
            if (item.created_at && !isArchived && !isCompleted) {
                const diffHours = (new Date() - new Date(item.created_at)) / (1000 * 60 * 60);
                if (diffHours < NEW_BADGE_HOURS) isNew = true;
            }

            const pinBadge = item.pinned ? '<span class="mr-2 inline-flex items-center rounded-full bg-yellow-500 px-2 py-0.5 text-xs font-medium text-black shadow-md"><i class="ph ph-push-pin-fill ml-1"></i>مثبت</span>' : '';
            const newBadge = isNew ? '<span class="mr-2 inline-flex items-center rounded-full bg-red-600 px-2 py-0.5 text-xs font-medium text-white animate-pulse"><i class="ph ph-sparkle ml-1"></i>جديد</span>' : '';
            
            // NEW: Priority Badge
            const priority = PRIORITY_MAP[item.priority] || PRIORITY_MAP['normal'];
            const priorityBadge = (item.priority !== 'normal' || isCompleted) ? '' : `<span class="mr-2 inline-flex items-center rounded-full ${priority.color} px-2 py-0.5 text-xs font-medium shadow-md">${priority.text}</span>`;
            
            const badges = `${newBadge} ${pinBadge} ${priorityBadge}`;

            // --- Subtasks ---
            const subtaskMap = getSubtaskMap();
            const subtasksHtml = renderSubtasks(item, subtaskMap);
            const subtasksContainer = subtasksHtml ? `<div class="subtask-list">${subtasksHtml}</div>` : '';
            
            // Disable main complete button if subtasks exist and are not all done
            const completedSubtasksCount = subtaskMap[item.id]?.length || 0;
            const allSubtasksDone = (item.subtasks.length > 0) && (completedSubtasksCount === item.subtasks.length);
            const mainCheckDisabled = (item.subtasks.length > 0) && !allSubtasksDone;
            
            let actionControls = '';
            if (isAdmin) {
                // Admin Controls (Edit/Delete)
                actionControls = `
                    <div class="mt-3 pt-3 border-t flex space-x-2 flex-row-reverse justify-end" style="border-color: var(--card-border);">
                        <button onclick="showEditModal('${subjectName}', '${item.id}')" class="text-xs text-primary-500 hover:text-primary-400 font-medium">
                            <i class="ph ph-pencil-simple-line ml-1"></i>تعديل
                        </button>
                        <button onclick="deleteRequirement('${subjectName}', '${item.id}', true)" class="text-xs text-gray-500 hover:text-gray-400 font-medium">
                            <i class="ph ph-trash ml-1"></i>حذف
                        </button>
                    </div>
                `;
            } else {
                // Student Controls
                actionControls = `
                    <div class="mt-3 pt-3 border-t flex justify-between items-center" style="border-color: var(--card-border);">
                        <label class="flex items-center cursor-pointer text-sm font-medium ${mainCheckDisabled ? 'text-gray-500 cursor-not-allowed' : 'text-green-400'}">
                            <input type="checkbox" onchange="toggleCompleted('${item.id}')" ${isCompleted ? 'checked' : ''} ${mainCheckDisabled ? 'disabled' : ''}
                                   class="main-task-checkbox form-checkbox h-5 w-5 text-primary-500 border-gray-600 rounded focus:ring-primary-500" style="margin-left: 0.5rem;">
                            <span class="${mainCheckDisabled ? 'opacity-60' : ''}">${isCompleted ? 'تم الإنجاز' : (mainCheckDisabled ? 'أكمل المهام الفرعية أولاً' : 'وضع كمنجز')}</span>
                        </label>
                        
                        <!-- NEW: Need Help Button -->
                        <button onclick="showHelpModal('${item.title}')" class="text-xs text-gray-400 hover:text-secondary font-medium flex items-center">
                            <i class="ph ph-question ml-1"></i> أحتاج مساعدة؟
                        </button>
                    </div>
                `;
            }
            
            // NEW: Selection Mode UI
            const selectionIndicator = isSelectMode ? `
                <div class="absolute top-2 left-2">
                    <input type="checkbox" ${selectedItems.has(item.id) ? 'checked' : ''} 
                           class="h-5 w-5 text-primary-600 rounded border-gray-500 focus:ring-primary-500" 
                           onclick="event.stopPropagation(); toggleItemSelection('${item.id}');">
                </div>` : '';
            
            const cardClasses = [
                'requirement-card', 'p-4', 'rounded-xl', 'transition-all', cardOpacity, 'relative',
                (isSelectMode ? 'selection-mode' : ''),
                (selectedItems.has(item.id) ? 'selected' : '')
            ].join(' ');
            
            const cardClickAction = isSelectMode ? `onclick="toggleItemSelection('${item.id}')"` : '';

            return `
                <div id="card-${item.id}" class="${cardClasses}" ${cardClickAction}>
                    ${selectionIndicator}
                    <div class="flex items-start justify-between ${isSelectMode ? 'pl-8' : ''}">
                        <div class="flex items-start">
                            ${getIconForType(item.type)}
                            <h3 class="mr-3 text-lg font-semibold">${item.title}</h3>
                        </div>
                        <div class="flex-shrink-0">${badges}</div>
                    </div>
                    ${descriptionHtml}
                    ${subtasksContainer}
                    <div class="mt-3 text-xs font-mono opacity-80 flex items-center justify-between">
                        <p class="font-medium ${dueDate.class}">
                            ${dueDate.text}
                        </p>
                        ${fileElement}
                    </div>
                    ${actionControls}
                </div>
            `;
        }
        
        window.toggleDescription = function(subjectName, itemId) {
            const descElement = document.getElementById(`desc-${itemId}`);
            const btnElement = document.getElementById(`btn-${itemId}`);
            const item = findItem(itemId)?.item;
            if (!descElement || !btnElement || !item) return;

            const isExpanded = btnElement.dataset.expanded === 'true';
            if (isExpanded) {
                descElement.textContent = item.description.substring(0, TRUNCATE_LENGTH) + '... ';
                btnElement.innerHTML = '...أكثر <i class="ph ph-caret-down mr-1"></i>';
                btnElement.dataset.expanded = 'false';
            } else {
                descElement.textContent = item.description;
                btnElement.innerHTML = '...أقل <i class="ph ph-caret-up mr-1"></i>';
                btnElement.dataset.expanded = 'true';
            }
        }
        
        // --- NEW: Help Modal ---
        window.showHelpModal = function(taskTitle) {
            const email = currentData?.meta?.contact_email || 'teacher@example.com';
            const subject = `مساعدة بخصوص: ${taskTitle}`;
            const body = `مرحباً، أواجه مشكلة في مهمة "${taskTitle}" وأحتاج إلى بعض المساعدة.\n\n(يرجى وصف مشكلتك هنا...)`;
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            document.getElementById('modal-content').innerHTML = `
                 <h2 class="text-xl font-bold mb-4 text-center">طلب مساعدة</h2>
                 <p class="text-sm opacity-80 mb-6 text-center">سيؤدي الضغط على الزر أدناه إلى فتح برنامج البريد الإلكتروني الخاص بك لطلب المساعدة من المسؤول.</p>
                 <a href="${mailtoLink}" target="_blank" class="w-full text-center py-3 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors flex items-center justify-center">
                     <i class="ph ph-envelope-simple ml-2"></i> إرسال بريد إلكتروني
                 </a>
                 <button onclick="closeModal()" class="w-full py-2 rounded-lg text-sm transition-colors hover:bg-gray-700 mt-3">إغلاق</button>
             `;
             showModal();
        }

        window.showFilePreviewModal = function(subjectName, itemId) {
             const item = findItem(itemId)?.item;
             if (!item || !item.file) {
                 showNotification("لا يوجد ملف مرفق لعرضه.", 'error');
                 return;
             }
             
             const fileUrl = item.file;
             const fileDisplayName = item.file_display_name || 'ملف مرفق';
             const isImage = fileUrl.toLowerCase().match(/\.(jpeg|jpg|png|gif|webp)$/);
             
             let previewContent = '';
             let buttonText = 'فتح الرابط الخارجي';
             
             if (isImage) {
                 previewContent = `<img src="${fileUrl}" alt="${fileDisplayName}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/EF4444/FFFFFF?text=تعذر عرض الصورة'">`;
                 buttonText = 'عرض الصورة في نافذة جديدة';
             } else {
                 previewContent = `<p class="text-center py-4 opacity-80">الملف عبارة عن مستند (${getFileDisplayInfo(fileUrl).displayName}) أو رابط خارجي. سيتم فتحه في نافذة جديدة.</p>`;
                 buttonText = 'فتح الملف/المستند';
             }

             document.getElementById('modal-content').innerHTML = `
                 <h2 class="text-xl font-bold mb-4 text-center">${fileDisplayName}</h2>
                 <div id="file-preview-content" class="mb-4">${previewContent}</div>
                 <div class="mt-6 flex flex-col space-y-3">
                     <a href="${fileUrl}" target="_blank" class="w-full text-center py-3 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">
                         <i class="ph ph-arrow-square-out ml-2"></i> ${buttonText}
                     </a>
                     <button onclick="closeModal()" class="w-full py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إغلاق</button>
                 </div>
             `;
             document.getElementById('modal-content').classList.add('max-w-xl');
             showModal();
        }


        function renderFilterButton(subjectName, filterType, label, icon) {
            const isActive = currentFilters[subjectName] === filterType;
            const baseClasses = "px-3 py-1 text-xs rounded-full transition-all flex items-center whitespace-nowrap";
            const activeClasses = "bg-primary-600 text-white shadow-md hover:bg-primary-700"; 
            const inactiveClasses = "bg-gray-700 text-gray-200 hover:bg-gray-600";
            return `
                <button onclick="setFilter('${subjectName}', '${filterType}')" class="${baseClasses} ${isActive ? activeClasses : inactiveClasses}">
                    <i class="${icon} ml-1"></i> ${label}
                </button>
            `;
        }
        
        function updateAdminUI() {
             const adminToggle = document.getElementById('admin-toggle');
             const addSubjectButton = document.getElementById('add-subject-button');
             const addAnnouncementBtn = document.getElementById('add-announcement-button');
             const adminSelectToggle = document.getElementById('admin-select-toggle');
             
             if (adminToggle) {
                 if (isAdmin) {
                     adminToggle.innerHTML = '<i class="ph ph-shield-check text-base ml-1"></i> وضع المسؤول';
                     adminToggle.classList.replace('text-gray-800', 'text-white');
                     adminToggle.classList.replace('bg-white', 'bg-primary-600');
                     adminToggle.classList.replace('hover:bg-gray-200', 'hover:bg-primary-700');
                 } else {
                     adminToggle.innerHTML = 'المسؤول';
                     adminToggle.classList.replace('text-white', 'text-gray-800');
                     adminToggle.classList.replace('bg-primary-600', 'bg-white');
                     adminToggle.classList.replace('hover:bg-primary-700', 'hover:bg-gray-200');
                 }
            }
            if (addSubjectButton) addSubjectButton.classList.toggle('hidden', !isAdmin);
            if (addAnnouncementBtn) addAnnouncementBtn.classList.toggle('hidden', !isAdmin);
            if (adminSelectToggle) adminSelectToggle.classList.toggle('hidden', !isAdmin);
            
            // Re-render admin dashboard if it's open
            if(document.getElementById('admin-dashboard').style.display !== 'none') {
                renderAdminDashboard();
            }
        }

        // --- NEW: Render Announcements ---
        function renderAnnouncements() {
            const container = document.getElementById('announcements-container');
            if (!container || !currentData.announcements || currentData.announcements.length === 0) {
                if (container) container.innerHTML = !isAdmin ? '<p class="text-sm opacity-60 italic">لا توجد إعلانات حالياً.</p>' : '';
                return;
            }
            
            // Sort by creation date, newest first
            const sorted = [...currentData.announcements].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            container.innerHTML = sorted.map(anno => {
                const date = new Date(anno.created_at).toLocaleDateString('ar-EG', { day: 'numeric', month: 'long' });
                return `
                    <div class="p-4 rounded-lg relative" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
                        ${isAdmin ? `
                            <button onclick="deleteAnnouncement('${anno.id}')" class="absolute top-2 left-2 p-1 text-gray-500 hover:text-red-500">
                                <i class="ph ph-trash text-sm"></i>
                            </button>
                        ` : ''}
                        <h3 class="text-lg font-semibold text-primary-500">${anno.title}</h3>
                        <p class="text-sm opacity-80 mt-1">${anno.description}</p>
                        <p class="text-xs opacity-50 mt-2 font-mono">${date}</p>
                    </div>
                `;
            }).join('');
        }

        function renderApp() {
            if (!currentData) {
                document.getElementById('subjects-container').innerHTML = '<p class="text-center py-10 text-xl font-medium text-gray-500">جاري تحميل بيانات الصف...</p>';
                return;
            }
            
            updateAdminUI();
            
            // NEW: Render Announcements
            renderAnnouncements();

            const globalSearchTerm = document.getElementById('global-search-input').value.toLowerCase().trim();
            const content = document.getElementById('subjects-container');
            let mainContentHTML = '';
            
            const subjectKeys = SUBJECTS.sort((a, b) => a.localeCompare(b, 'ar'));
            
            let totalTasks = 0;
            let completedTasks = 0;
            let dueTodayTasks = 0; 
            let overdueTasks = 0; 
            
            // --- 1. Calculate Stats & Filter Items ---
            const completedItems = getCompletedItems();
            let allFilteredItems = []; // For "Due Today" filter
            
            subjectKeys.forEach(subjectName => {
                const allRequirements = currentData.subjects[subjectName] || [];
                let subjectItems = [];

                allRequirements.forEach(item => {
                    totalTasks++;
                    const itemDate = parseDate(item.due_date);
                    
                    if (completedItems.has(item.id)) {
                        completedTasks++;
                        return; // Don't count completed items in other stats
                    }

                    if (isDueToday(itemDate)) dueTodayTasks++;
                    if (isDuePast(itemDate)) overdueTasks++;

                    // Add to list for rendering
                    subjectItems.push(item);
                });
                
                // Apply global search filter
                if (globalSearchTerm) {
                    subjectItems = subjectItems.filter(item => {
                        const title = item.title.toLowerCase();
                        const description = item.description.toLowerCase();
                        return title.includes(globalSearchTerm) || description.includes(globalSearchTerm);
                    });
                }
                
                // Add subjectName to items for global filtering
                allFilteredItems.push(...subjectItems.map(item => ({ ...item, subjectName })));
            });

            // --- 2. Update Header Stats ---
            document.getElementById('due-today-count').textContent = dueTodayTasks;
            document.getElementById('overdue-count').textContent = overdueTasks;
            document.getElementById('remaining-count').textContent = totalTasks - completedTasks;
            document.getElementById('completed-count').textContent = completedTasks;
            
            const completedPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('completed-percent').textContent = completedPercent + '%';
            document.getElementById('progress-bar').style.width = `${completedPercent}%`;
            document.getElementById('footer-completion-status').textContent = `${completedPercent}%`;
            document.getElementById('last-updated-display').textContent = lastUpdateTime ? `آخر تحديث: ${lastUpdateTime}` : '';

            // Update motivational message
            const motMsg = document.getElementById('motivational-message');
            if (motMsg) {
                if (totalTasks === 0) motMsg.textContent = "لا توجد مهام حالياً.";
                else if (totalTasks - completedTasks === 0) motMsg.textContent = "أداء رائع! كل المهام منجزة.";
                else motMsg.textContent = "واصل التقدم!";
            }


            // --- 3. Apply Global "Due Today" Filter ---
            let itemsToRender = allFilteredItems;
            if (isDueTodayFilterActive) {
                itemsToRender = allFilteredItems.filter(item => isDueToday(parseDate(item.due_date)));
            }
            
            // --- 4. Group items by subject for rendering ---
            const groupedItems = itemsToRender.reduce((acc, item) => {
                if (!acc[item.subjectName]) {
                    acc[item.subjectName] = { current: [], archived: [] };
                }
                if (isDuePast(parseDate(item.due_date))) {
                    acc[item.subjectName].archived.push(item);
                } else {
                    acc[item.subjectName].current.push(item);
                }
                return acc;
            }, {});

            // --- 5. Render Subjects ---
            subjectKeys.forEach(subjectName => {
                const subjectGroup = groupedItems[subjectName];
                if (!subjectGroup && !isAdmin && !globalSearchTerm) return; // Skip empty subjects unless admin or searching

                const currentItems = subjectGroup?.current || [];
                const archivedItems = subjectGroup?.archived || [];
                const currentFilter = currentFilters[subjectName];
                
                // Apply local (subject-specific) filtering
                let filteredItems = currentItems.filter(item => {
                    if (isDueTodayFilterActive) return true; // Already filtered globally
                    if (!currentFilter) return true;
                    return (currentFilter === 'pinned' && item.pinned) || item.type === currentFilter;
                });

                // Sort current items: Pinned > Priority > Due Date
                filteredItems.sort((a, b) => {
                    if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
                    const priorityOrder = { 'high': 3, 'normal': 2, 'low': 1 };
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return (priorityOrder[b.priority] || 2) - (priorityOrder[a.priority] || 2);
                    }
                    if (a.due_date && b.due_date) return new Date(a.due_date) - new Date(b.due_date);
                    return 0;
                });

                // Sort archived items (most recent first)
                archivedItems.sort((a, b) => (new Date(b.due_date) - new Date(a.due_date)));
                
                // UPDATED: Filter buttons list (merged file/link)
                const filtersHtml = `
                    <div class="flex gap-2 mt-4 overflow-x-auto pb-2">
                        ${renderFilterButton(subjectName, 'homework', 'الواجبات', 'ph ph-note-pencil')}
                        ${renderFilterButton(subjectName, 'exam', 'الاختبارات', 'ph ph-book-open-text')}
                        ${renderFilterButton(subjectName, 'research', 'البحوث', 'ph ph-magnifying-glass')}
                        ${renderFilterButton(subjectName, 'link', 'الروابط/الملفات', 'ph ph-link')}
                        ${renderFilterButton(subjectName, 'pinned', 'المثبتة', 'ph ph-push-pin')}
                        ${currentFilter ? renderFilterButton(subjectName, 'reset', 'إعادة تعيين', 'ph ph-x-circle') : ''}
                    </div>
                `;

                const currentItemsHtml = filteredItems.length > 0
                    ? filteredItems.map(item => renderRequirementCard(subjectName, item, false)).join('')
                    : `<p class="text-sm opacity-60 italic py-4">لا توجد متطلبات مطابقة لمعايير التصفية لـ ${subjectName}.</p>`;
                
                // Show section only if there are items or admin can add
                if (filteredItems.length > 0 || isAdmin || (archivedItems.length > 0 && !globalSearchTerm)) {
                    mainContentHTML += `
                        <section id="subject-section-${subjectName.replace(/\s/g, '-')}" class="mb-12">
                            <div class="flex justify-between items-center mb-1 border-b pb-2" style="border-color: var(--card-border);">
                                <h2 class="text-2xl font-bold text-gradient">${subjectName}</h2>
                                ${isAdmin ? `
                                    <button onclick="showAddModal('${subjectName}')" class="text-sm text-primary-500 hover:text-primary-700 font-semibold focus:outline-none">
                                        <i class="ph ph-plus-circle ml-1"></i>إضافة جديد
                                    </button>
                                ` : ''}
                            </div>
                            ${!isDueTodayFilterActive ? filtersHtml : ''}
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                                ${currentItemsHtml}
                            </div>
                        </section>
                    `;
                }

                // Render Archive Section
                if (archivedItems.length > 0) {
                    const isGlobalHidden = localStorage.getItem(GLOBAL_ARCHIVE_KEY) === 'true';
                    const key = ARCHIVE_KEY_PREFIX + subjectName;
                    const isLocalHidden = localStorage.getItem(key) === 'false';
                    const isVisible = !isGlobalHidden && !isLocalHidden;
                    
                    const archiveHtml = archivedItems.map(item => renderRequirementCard(subjectName, item, true)).join('');
                    
                    mainContentHTML += `
                        <section class="mb-12 border-t pt-6" style="border-color: var(--card-border);">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold opacity-70 flex items-center text-gray-500">
                                    <i class="ph ph-archive ml-2"></i> أرشيف ${subjectName}
                                </h3>
                                ${isGlobalHidden ? `<span class="text-xs text-gray-500">مخفي عالميًا</span>` : `
                                <button onclick="toggleArchiveVisibility('${subjectName}')" class="text-xs font-semibold text-gray-400 hover:text-primary-400 transition-colors flex items-center">
                                    <i class="ph ph-${isVisible ? 'caret-up' : 'caret-down'} ml-1"></i>
                                    ${isVisible ? 'إخفاء' : 'عرض'} الأرشيف (${archivedItems.length})
                                </button>
                                `}
                            </div>
                            ${isVisible ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${archiveHtml}</div>` : ''}
                        </section>
                    `;
                }
            });
            
            // Handle Empty States
            if (mainContentHTML === '') {
                 if (globalSearchTerm) mainContentHTML = `<p class="text-center py-10 text-xl font-medium text-gray-500">لم يتم العثور على نتائج للبحث عن: "${globalSearchTerm}"</p>`;
                 else if (isDueTodayFilterActive) mainContentHTML = `<p class="text-center py-10 text-xl font-medium text-gray-500">لا توجد مهام تستحق اليوم. رائع!</p>`;
                 else if (isAdmin) mainContentHTML = `
                        <div class="text-center py-10">
                            <i class="ph ph-rocket-launch text-6xl text-primary-500"></i>
                            <h2 class="mt-4 text-2xl font-bold">مرحباً أيها المدير!</h2>
                            <p class="mt-2 text-lg opacity-80">لم تتم إضافة أي مواد. انقر على "إضافة مادة" للبدء.</p>
                        </div>`;
                 else mainContentHTML = `
                        <div class="text-center py-10">
                            <i class="ph ph-coffee text-6xl text-green-500"></i>
                            <h2 class="mt-4 text-2xl font-bold">الصفحة فارغة حالياً</h2>
                            <p class="mt-2 text-lg opacity-80">لا توجد أي متطلبات منشورة. استمتع بوقتك!</p>
                        </div>`;
            }
            content.innerHTML = mainContentHTML;
        }

        // --- DARK MODE LOGIC ---
        window.toggleDarkMode = function() {
            isDarkMode = !isDarkMode;
            const theme = isDarkMode ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            document.body.classList.toggle('dark', isDarkMode);
            localStorage.setItem(THEME_KEY, theme);
            document.getElementById('mode-icon').classList.toggle('ph-moon', !isDarkMode);
            document.getElementById('mode-icon').classList.toggle('ph-sun', isDarkMode);
        };

        // --- QR CODE LOGIC ---
        window.showQrModal = function() {
            document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">رمز QR للوصول السريع</h2>
                <p class="text-center mb-4 text-sm opacity-80">امسح الرمز ضوئيًا بهاتفك للوصول المباشر إلى هذه الصفحة.</p>
                <div id="qrcode" class="p-4 bg-white rounded-lg shadow-inner w-48 h-48 mx-auto"></div>
                <div class="mt-4">
                    <button onclick="copyPageUrl()" class="w-full text-center py-2 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">
                        <i class="ph ph-copy-simple ml-2"></i> نسخ الرابط
                    </button>
                </div>
                <div class="mt-2 flex justify-center">
                    <button onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إغلاق</button>
                </div>
            `;
            showModal();
            new QRCode(document.getElementById("qrcode"), {
                text: window.location.href, width: 160, height: 160,
                colorDark : "#4F46E5", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        };
        
        window.copyPageUrl = function() {
            try {
                const tempInput = document.createElement('input');
                document.body.appendChild(tempInput);
                tempInput.value = window.location.href;
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showNotification('تم نسخ الرابط إلى الحافظة!', 'success', 2000);
            } catch (e) {
                showNotification('فشل نسخ الرابط.', 'error', 2000);
            }
        }


        // --- BILLBOARD MODAL LOGIC ---
        window.showBillboardModal = function(config) {
            if (sessionStorage.getItem(BILLBOARD_SEEN_KEY)) return;
            const backdrop = document.getElementById('billboard-modal-backdrop');
            const content = document.getElementById('billboard-modal-content');
            if (!backdrop || !content) return;
            
            const {
                title = 'إعلان هام', imageURL = 'https://placehold.co/600x400/EF4444/FFFFFF?text=MISSING+IMAGE',
                bodyText = 'لا يوجد نص للإعلان.', buttonText = 'حسناً', linkURL = ''
            } = config;
            
            content.innerHTML = `
                <button id="billboard-modal-close-btn" onclick="closeBillboardModal()"><i class="ph ph-x text-lg"></i></button>
                <img src="${imageURL}" alt="${title}" class="w-full h-96 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/EF4444/FFFFFF?text=Image+Error'">
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-3 text-gradient">${title}</h2>
                    <p class="text-sm opacity-80 mb-6">${bodyText}</p>
                    ${linkURL ? `
                    <a href="${linkURL}" target="_blank" onclick="closeBillboardModal()" class="w-full text-center py-2 rounded-lg text-sm font-semibold transition-colors bg-primary-600 hover:bg-primary-700 text-white block">
                        <i class="ph ph-arrow-square-out ml-2"></i> ${buttonText}
                    </a>` : `
                    <button onclick="closeBillboardModal()" class="w-full py-2 rounded-lg text-sm font-semibold transition-colors bg-primary-600 hover:bg-primary-700 text-white">
                        ${buttonText}
                    </button>`}
                    <button onclick="closeBillboardModal()" class="w-full py-2 rounded-lg text-sm transition-colors hover:bg-gray-700 mt-2">
                        إغلاق الإعلان
                    </button>
                </div>
            `;

            backdrop.classList.remove('hidden'); backdrop.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.add('opacity-100');
                content.classList.remove('scale-95', 'opacity-0');
            }, 10);
            sessionStorage.setItem(BILLBOARD_SEEN_KEY, 'true'); 
        }

        window.closeBillboardModal = function() {
            const backdrop = document.getElementById('billboard-modal-backdrop');
            const content = document.getElementById('billboard-modal-content');
            if (!backdrop || !content) return;

            backdrop.classList.remove('opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { backdrop.classList.add('hidden'); }, 300);
        }


        // --- MODAL CONTROLS ---
        function showModal() {
            const backdrop = document.getElementById('modal-backdrop');
            const content = document.getElementById('modal-content');
            backdrop.classList.remove('hidden'); backdrop.classList.add('flex');
            setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); }, 10);
        }

        window.closeModal = function() {
            const backdrop = document.getElementById('modal-backdrop');
            const content = document.getElementById('modal-content');
            content.classList.add('scale-95', 'opacity-0');
            content.classList.remove('max-w-xl', 'max-w-4xl'); // Reset size
            content.classList.add('max-w-md');
            setTimeout(() => {
                backdrop.classList.add('hidden');
                content.innerHTML = '';
            }, 300);
        };
        
        function showLoadingModal(message = 'جارٍ جلب البيانات...') {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-modal-backdrop').classList.remove('hidden');
            document.getElementById('loading-modal-backdrop').classList.add('flex');
        }
        function hideLoadingModal() {
            document.getElementById('loading-modal-backdrop').classList.add('hidden');
            document.getElementById('loading-modal-backdrop').classList.remove('flex');
        }

        /**
         * Shows a transient notification (toast).
         * @param {string} message The message to display.
         * @param {string} type The type (success, error, info).
         * @param {number} duration The duration in milliseconds.
         * @param {string} actionText Text for the optional action button (e.g., 'Undo').
         * @param {string} actionCallback The JS function string to execute on action click.
         */
        function showNotification(message, type = 'info', duration = 3000, actionText = null, actionCallback = null) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            let icon = '';
            switch(type) {
                case 'success': icon = '<i class="ph ph-check-circle text-lg text-green-400 ml-2"></i>'; break;
                case 'error': icon = '<i class="ph ph-x-octagon text-lg text-red-400 ml-2"></i>'; break;
                case 'info': icon = '<i class="ph ph-info text-lg text-blue-400 ml-2"></i>'; break;
            }
            toast.className = `toast ${type} flex items-center text-sm`;
            
            let actionButton = '';
            if (actionText && actionCallback) {
                actionButton = `<button onclick="${actionCallback}; this.closest('.toast').remove();" class="toast-action-btn">${actionText}</button>`;
            }

            toast.innerHTML = `${icon} <span class="flex-1">${message}</span> ${actionButton}`;
            container.appendChild(toast);
            
            // Function to manually dismiss the toast
            const dismissToast = () => {
                 toast.classList.remove('show');
                 setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 400);
            };

            setTimeout(() => { toast.classList.add('show'); }, 50);
            
            // Set up auto-dismiss
            setTimeout(dismissToast, duration);
            
            // If action is present, ensure the completion timer is cleared when dismissed
            if (actionButton) {
                 // Clean up timer if the toast is manually dismissed or times out
                 const originalDismiss = dismissToast;
                 dismissToast = () => {
                     if (completionTimer) clearTimeout(completionTimer);
                     if (pendingCompletionItemId) pendingCompletionItemId = null;
                     originalDismiss();
                 };
            }
        }
        window.showNotification = showNotification;


        // --- ADMIN LOGIN & DASHBOARD ---
        
        // NEW: Renamed function
        window.showAdminPanel = function() {
            if (isAdmin) {
                // Show Admin Dashboard
                document.getElementById('main-content-wrapper').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
                document.getElementById('admin-toggle').innerHTML = '<i class="ph ph-sign-out text-base ml-1"></i> تسجيل الخروج';
                document.getElementById('admin-toggle').onclick = performAdminLogout;
                renderAdminDashboard(); // Render dashboard content
            } else {
                // Show Login Modal
                showAdminLoginModal();
            }
        };
        
        // NEW: Close dashboard and return to main view
        window.closeAdminPanel = function() {
            document.getElementById('main-content-wrapper').style.display = 'block';
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('admin-toggle').innerHTML = '<i class="ph ph-shield-check text-base ml-1"></i> وضع المسؤول';
            document.getElementById('admin-toggle').onclick = showAdminPanel;
        };

        window.showAdminLoginModal = function() {
            document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">تسجيل دخول المسؤول</h2>
                <input type="password" id="admin-pass-input" placeholder="أدخل كلمة مرور المسؤول" class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500 mb-4" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                <p id="admin-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <div class="flex justify-start space-x-3 space-x-reverse">
                    <button onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إلغاء</button>
                    <button onclick="attemptAdminLogin()" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">دخول</button>
                </div>
            `;
            showModal();
        };

        window.attemptAdminLogin = function() {
            const input = document.getElementById('admin-pass-input').value;
            const errorElement = document.getElementById('admin-error');
            if (!currentData || !currentData.meta) {
                 errorElement.textContent = "خطأ: لم يتم تحميل بيانات التكوين.";
                 errorElement.classList.remove('hidden');
                 return;
            }
            if (currentData.meta.admin_pass === "PLEASE_SET_A_PASSWORD") {
                errorElement.textContent = "تنبيه: يتم استخدام كلمة المرور الافتراضية. يرجى تغييرها فوراً.";
                errorElement.classList.replace('text-red-500', 'text-yellow-500');
                errorElement.classList.remove('hidden');
            }

            if (input === currentData.meta.admin_pass) {
                isAdmin = true;
                closeModal();
                updateAdminUI(); // Update buttons
                showAdminPanel(); // Open dashboard
                renderApp(); // Re-render main content (in background)
                showNotification('تم تسجيل الدخول بنجاح كمسؤول.', 'success');
            } else {
                errorElement.textContent = "كلمة المرور غير صحيحة. حاول مرة أخرى.";
                errorElement.classList.replace('text-yellow-500', 'text-red-500');
                errorElement.classList.remove('hidden');
                showNotification('فشل تسجيل الدخول: كلمة مرور غير صحيحة.', 'error', 2000);
            }
        };
        
        window.performAdminLogout = function() {
             isAdmin = false;
             isSelectMode = false; // NEW: Exit select mode on logout
             updateAdminUI(); // Update buttons
             closeAdminPanel(); // Close dashboard
             renderApp();
             showNotification('تم تسجيل الخروج من وضع المسؤول.', 'info');
             // Reset admin button function
             document.getElementById('admin-toggle').innerHTML = 'المسؤول';
             document.getElementById('admin-toggle').onclick = showAdminPanel;
             document.getElementById('admin-toggle').classList.replace('text-white', 'text-gray-800');
             document.getElementById('admin-toggle').classList.replace('bg-primary-600', 'bg-white');
             document.getElementById('admin-toggle').classList.replace('hover:bg-primary-700', 'hover:bg-gray-200');
        };
        
        // --- NEW: Admin Dashboard Rendering ---
        
        window.switchAdminTab = function(tabId) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`button[onclick="switchAdminTab('${tabId}')"]`).classList.add('active');
        }
        
        function renderAdminDashboard() {
            // 1. Render Subjects List
            const subjectsList = document.getElementById('admin-subjects-list');
            if (subjectsList) {
                subjectsList.innerHTML = SUBJECTS.map(subjectName => {
                    const itemCount = currentData.subjects[subjectName]?.length || 0;
                    return `
                        <div class="p-4 rounded-lg flex justify-between items-center" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
                            <div>
                                <h4 class="text-lg font-semibold">${subjectName}</h4>
                                <span class="text-sm opacity-60">${itemCount} متطلب</span>
                            </div>
                            <button onclick="confirmSubjectDeletion('${subjectName.replace(/'/g, "\\'")}', ${itemCount > 0})" class="px-3 py-1 rounded-full text-xs font-semibold text-white bg-red-600 hover:bg-red-700 transition-colors">
                                <i class="ph ph-trash ml-1"></i> حذف
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            // 2. Render Announcements List
            const announcementsList = document.getElementById('admin-announcements-list');
            if (announcementsList) {
                const sorted = [...currentData.announcements].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                announcementsList.innerHTML = sorted.map(anno => `
                    <div class="p-3 rounded-lg flex justify-between items-center" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
                        <div>
                            <h4 class="font-medium">${anno.title}</h4>
                            <p class="text-xs opacity-60">${anno.description.substring(0, 50)}...</p>
                        </div>
                        <button onclick="deleteAnnouncement('${anno.id}')" class="p-2 rounded-full text-gray-400 hover:text-red-500 hover:bg-gray-700">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                `).join('');
                if (sorted.length === 0) {
                     announcementsList.innerHTML = `<p class="text-sm opacity-60 italic">لا توجد إعلانات لعرضها.</p>`;
                }
            }
            
            // 3. Render Settings
            const devToolsBtn = document.getElementById('admin-devtools-toggle');
            if (devToolsBtn) {
                const isLockEnabled = localStorage.getItem(DEV_LOCK_KEY) !== 'false';
                devToolsBtn.textContent = isLockEnabled ? 'تعطيل القفل' : 'تفعيل القفل';
                devToolsBtn.className = `w-full px-3 py-2 rounded-lg text-sm font-semibold text-white ${isLockEnabled ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`;
            }
        }
        
        window.showChangePasswordModal = function() {
            document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">تغيير كلمة مرور المسؤول</h2>
                <form id="password-change-form" onsubmit="event.preventDefault(); performPasswordChange()">
                    <label for="current-pass" class="block text-sm font-medium mb-1 mt-3">كلمة المرور الحالية</label>
                    <input type="password" id="current-pass" required class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                    <label for="new-pass" class="block text-sm font-medium mb-1 mt-3">كلمة المرور الجديدة</label>
                    <input type="password" id="new-pass" required class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                    <label for="confirm-pass" class="block text-sm font-medium mb-1 mt-3">تأكيد كلمة المرور الجديدة</label>
                    <input type="password" id="confirm-pass" required class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                    <p id="password-error" class="text-red-500 text-sm mb-4 mt-2 hidden"></p>
                    <div class="mt-6 flex justify-start space-x-3 space-x-reverse">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إلغاء</button>
                        <button type="submit" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">حفظ</button>
                    </div>
                </form>
            `;
            showModal();
        };
        
        window.performPasswordChange = function() {
            if (!isAdmin) return;
            const currentPass = document.getElementById('current-pass').value;
            const newPass = document.getElementById('new-pass').value;
            const confirmPass = document.getElementById('confirm-pass').value;
            const errorElement = document.getElementById('password-error');
            if (currentPass !== currentData.meta.admin_pass) {
                errorElement.textContent = "كلمة المرور الحالية غير صحيحة.";
                errorElement.classList.remove('hidden'); return;
            }
            if (!newPass || newPass.length < 6) {
                 errorElement.textContent = "كلمة المرور الجديدة يجب أن تكون 6 أحرف على الأقل.";
                errorElement.classList.remove('hidden'); return;
            }
            if (newPass !== confirmPass) {
                errorElement.textContent = "كلمتا المرور الجديدتان غير متطابقتين.";
                errorElement.classList.remove('hidden'); return;
            }
            const newConfig = { ...currentData, meta: { ...currentData.meta, admin_pass: newPass } };
            currentData = newConfig; 
            updateJsonBinData(newConfig); 
            showNotification("تم تغيير كلمة مرور المسؤول بنجاح.", "success");
            closeModal();
        };
        
        // NEW: Edit Contact Email
        window.showContactEditModal = function() {
             if (!isAdmin) return;
             const email = currentData.meta.contact_email || '';
             document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">تعديل بريد التواصل</h2>
                <label for="contact-email" class="block text-sm font-medium mb-1 mt-3">البريد الإلكتروني</label>
                <input type="email" id="contact-email" value="${email}" placeholder="teacher@example.com" class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                <div class="mt-6 flex justify-start space-x-3 space-x-reverse">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إلغاء</button>
                    <button type="button" onclick="saveContactEmail()" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">حفظ</button>
                </div>
            `;
            showModal();
        }
        
        window.saveContactEmail = function() {
            if (!isAdmin) return;
            const email = document.getElementById('contact-email').value;
            const newConfig = { ...currentData, meta: { ...currentData.meta, contact_email: email } };
            currentData = newConfig;
            updateJsonBinData(newConfig);
            showNotification("تم تحديث بريد التواصل بنجاح.", "success");
            closeModal();
        }

        // --- NEW: Billboard Edit ---
        window.showBillboardEditModal = function() {
            if (!isAdmin) return;
            const billboard = currentData.billboard || MVP_DATA.billboard;
            document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">إدارة الإعلان (Billboard)</h2>
                <form id="billboard-edit-form" class="max-h-[70vh] overflow-y-auto p-1" onsubmit="event.preventDefault(); performBillboardUpdate()">
                    <label for="bb-title" class="block text-sm font-medium mb-1 mt-3">العنوان</label>
                    <input type="text" id="bb-title" value="${billboard.title || ''}" required class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                    <label for="bb-body" class="block text-sm font-medium mb-1 mt-3">نص الإعلان</label>
                    <textarea id="bb-body" rows="3" required class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);">${billboard.bodyText || ''}</textarea>
                    <label for="bb-image" class="block text-sm font-medium mb-1 mt-3">رابط الصورة</label>
                    <input type="text" id="bb-image" value="${billboard.imageURL || ''}" placeholder="https://example.com/image.png" required class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                    <label for="bb-btn-text" class="block text-sm font-medium mb-1 mt-3">نص الزر</label>
                    <input type="text" id="bb-btn-text" value="${billboard.buttonText || ''}" required class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                    <label for="bb-btn-link" class="block text-sm font-medium mb-1 mt-3">رابط الزر (اختياري)</label>
                    <input type="text" id="bb-btn-link" value="${billboard.linkURL || ''}" placeholder="https://example.com/" class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                    <div class="mt-4 flex items-center justify-end">
                        <label for="bb-enabled" class="mr-2 text-sm font-medium">تفعيل الإعلان (عرض للطلاب)</label>
                        <input type="checkbox" id="bb-enabled" ${billboard.isEnabled ? 'checked' : ''} class="w-4 h-4 text-primary-600 rounded border-gray-600 focus:ring-primary-500">
                    </div>
                    <div class="mt-6 flex justify-start space-x-3 space-x-reverse pt-4 border-t" style="border-color: var(--card-border);">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إلغاء</button>
                        <button type="submit" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">حفظ الإعلان</button>
                    </div>
                </form>
            `;
            showModal();
        };

        window.performBillboardUpdate = function() {
            if (!isAdmin) return;
            const updatedBillboard = {
                title: document.getElementById('bb-title').value,
                bodyText: document.getElementById('bb-body').value,
                imageURL: document.getElementById('bb-image').value,
                buttonText: document.getElementById('bb-btn-text').value,
                linkURL: document.getElementById('bb-btn-link').value.trim(),
                isEnabled: document.getElementById('bb-enabled').checked
            };
            const newConfig = { ...currentData, billboard: updatedBillboard };
            currentData = newConfig; 
            updateJsonBinData(newConfig); 
            showNotification("تم تحديث الإعلان بنجاح.", "success");
            closeModal();
        };
        
        window.toggleDevToolsLock = function() {
            if (!isAdmin) return;
            const isLockEnabled = localStorage.getItem(DEV_LOCK_KEY) !== 'false';
            const newState = !isLockEnabled;
            localStorage.setItem(DEV_LOCK_KEY, newState ? 'true' : 'false');
            showNotification(`تم ${newState ? 'تفعيل' : 'تعطيل'} قفل وضع المطور.`, 'info');
            renderAdminDashboard(); // Update button text
        };

        // --- SUBJECT CRUD ---
        window.confirmSubjectDeletion = function(subjectName, hasItems) {
            closeModal(); // Close Admin Panel
            let message = `هل أنت متأكد تماماً من حذف المادة **${subjectName}**؟`;
            if (hasItems) message += ` **تحذير: سيتم حذف جميع المتطلبات (${currentData.subjects[subjectName].length}) المرتبطة بهذه المادة بشكل دائم.**`;
            message += ` لا يمكن التراجع عن هذا الإجراء.`;
            const actionString = `performSubjectDeletion('${subjectName.replace(/'/g, "\\'")}')`;
            showInfoModal('تأكيد حذف المادة', message, actionString, 'نعم، احذف المادة', true);
        };
        
        window.performSubjectDeletion = function(subjectName) {
            if (!isAdmin) return;
            const section = document.getElementById(`subject-section-${subjectName.replace(/\s/g, '-')}`);
            if (section) section.classList.add('deleting');
            closeModal();
            
            setTimeout(() => {
                SUBJECTS = SUBJECTS.filter(s => s !== subjectName);
                const updatedSubjects = { ...currentData.subjects };
                delete updatedSubjects[subjectName];
                updateData({ ...currentData, subjects: updatedSubjects });
                showNotification(`تم حذف المادة: ${subjectName} بنجاح.`, 'success');
            }, 350);
        }

        window.showAddSubjectModal = function() {
             document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">إضافة مادة جديدة</h2>
                <input type="text" id="new-subject-input" placeholder="أدخل اسم المادة الجديدة" class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500 mb-4" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                <p id="subject-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <div class="flex justify-start space-x-3 space-x-reverse">
                    <button onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إلغاء</button>
                    <button onclick="attemptAddSubject()" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">إضافة</button>
                </div>
            `;
            showModal();
        };

        window.attemptAddSubject = function() {
            if (!isAdmin) return;
            const input = document.getElementById('new-subject-input').value.trim();
            const errorElement = document.getElementById('subject-error');
            if (!input) {
                errorElement.textContent = "اسم المادة لا يمكن أن يكون فارغًا.";
                errorElement.classList.remove('hidden'); return;
            }
            if (SUBJECTS.includes(input)) {
                 errorElement.textContent = "هذه المادة موجودة بالفعل.";
                 errorElement.classList.remove('hidden'); return;
            }
            SUBJECTS.push(input);
            SUBJECTS.sort((a, b) => a.localeCompare(b, 'ar'));
            const updatedSubjects = { ...currentData.subjects, [input]: [] };
            updateData({ ...currentData, subjects: updatedSubjects });
            showNotification(`تمت إضافة المادة: ${input}.`, 'success');
            closeModal();
        }

        // --- ANNOUNCEMENT CRUD (NEW) ---
        window.showAddAnnouncementModal = function() {
            if (!isAdmin) return;
             document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">إضافة إعلان جديد</h2>
                <form id="announcement-form" onsubmit="event.preventDefault(); saveAnnouncement()">
                    <label for="anno-title" class="block text-sm font-medium mb-1 mt-3">العنوان</label>
                    <input type="text" id="anno-title" required class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                    <label for="anno-desc" class="block text-sm font-medium mb-1 mt-3">الوصف</label>
                    <textarea id="anno-desc" rows="3" required class="w-full p-3 rounded-lg border focus:ring-primary-500 focus:border-primary-500" style="background-color: var(--bg-color); border-color: var(--card-border);"></textarea>
                    <div class="mt-6 flex justify-start space-x-3 space-x-reverse">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إلغاء</button>
                        <button type="submit" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">نشر الإعلان</button>
                    </div>
                </form>
            `;
            showModal();
        }
        
        window.saveAnnouncement = function() {
            if (!isAdmin) return;
            const title = document.getElementById('anno-title').value;
            const description = document.getElementById('anno-desc').value;
            if (!title || !description) return;
            
            const newAnnouncement = {
                id: crypto.randomUUID(),
                title, description,
                created_at: new Date().toISOString()
            };
            
            const updatedAnnouncements = [...currentData.announcements, newAnnouncement];
            updateData({ ...currentData, announcements: updatedAnnouncements });
            showNotification("تم نشر الإعلان بنجاح.", "success");
            closeModal();
        }
        
        window.deleteAnnouncement = function(annoId) {
            if (!isAdmin) return;
            const updatedAnnouncements = currentData.announcements.filter(a => a.id !== annoId);
            updateData({ ...currentData, announcements: updatedAnnouncements });
            showNotification("تم حذف الإعلان.", "info");
        }
        

        // --- REQUIREMENT CRUD ---
        function updateData(updatedData) {
            currentData = updatedData;
            updateJsonBinData(updatedData);
        }
        
        function cleanItemData(item) {
            const cleaned = {};
            cleaned.title = item.title ? item.title.trim() : 'متطلب بدون عنوان';
            cleaned.description = item.description ? item.description.trim() : '';
            cleaned.due_date = item.due_date || '';
            cleaned.type = item.type || 'note';
            cleaned.id = item.id;
            cleaned.pinned = !!item.pinned;
            cleaned.file = item.file || '';
            cleaned.file_display_name = item.file_display_name ? item.file_display_name.trim() : '';
            cleaned.created_at = item.created_at || null;
            cleaned.priority = item.priority || 'normal'; // NEW
            cleaned.subtasks = item.subtasks || []; // NEW
            
            if (cleaned.file && !cleaned.file_display_name) {
                 cleaned.file_display_name = getFileDisplayInfo(cleaned.file).displayName || 'ملف مرفق';
            }
            return cleaned;
        }

        window.showAddModal = function(subjectName) {
            const item = {
                title: '', description: '', due_date: '', type: 'homework', file: '', pinned: false,
                isNew: true, subjectName: subjectName, file_display_name: '',
                priority: 'normal', subtasks: []
            };
            renderEditModal(item);
        };

        window.showEditModal = function(subjectName, itemId) {
            const item = findItem(itemId)?.item;
            if (item) {
                renderEditModal({ ...item, isNew: false, subjectName: subjectName });
            }
        };
        
        window.updateFilePreview = function() {
            const linkInput = document.getElementById('modal-link');
            const previewElement = document.getElementById('link-preview');
            if (!linkInput || !previewElement) return;
            const url = linkInput.value.trim();
            if (!url) { previewElement.innerHTML = ''; return; }
            const fileInfo = getFileDisplayInfo(url);
            previewElement.innerHTML = `
                <span class="text-xs text-gray-400">معاينة:</span>
                <span class="text-xs text-primary-400 flex items-center mr-1">
                    ${fileInfo.icon} ${fileInfo.displayName}
                </span>`;
        }
        
        // --- NEW: Subtask editor in modal ---
        function renderSubtaskEditor(subtasks = []) {
            const tasksHtml = subtasks.map((task, index) => `
                <div class="flex items-center gap-2" data-index="${index}">
                    <input type="text" value="${task}" class="subtask-input w-full p-2 text-sm rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);">
                    <button type="button" onclick="removeSubtask(this)" class="p-1 text-gray-400 hover:text-red-500"><i class="ph ph-trash"></i></button>
                </div>
            `).join('');
            
            return `
                <div id="subtask-editor" class="space-y-2">
                    ${tasksHtml}
                </div>
                <button type="button" onclick="addSubtask()" class="mt-2 text-sm font-medium text-primary-500 hover:text-primary-600 flex items-center">
                    <i class="ph ph-plus-circle ml-1"></i> إضافة مهمة فرعية
                </button>
            `;
        }
        
        window.addSubtask = function() {
            const editor = document.getElementById('subtask-editor');
            const newIndex = editor.children.length;
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.dataset.index = newIndex;
            div.innerHTML = `
                <input type="text" placeholder="مهمة فرعية جديدة..." class="subtask-input w-full p-2 text-sm rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);">
                <button type="button" onclick="removeSubtask(this)" class="p-1 text-gray-400 hover:text-red-500"><i class="ph ph-trash"></i></button>
            `;
            editor.appendChild(div);
        }
        
        window.removeSubtask = function(button) {
            button.parentElement.remove();
        }
        
        function getSubtasksFromEditor() {
            const inputs = document.querySelectorAll('#subtask-editor .subtask-input');
            return Array.from(inputs).map(input => input.value.trim()).filter(Boolean);
        }

        function renderEditModal(item) {
            const typeOptions = Object.keys(TYPE_MAP).map(key => `<option value="${key}" ${key === item.type ? 'selected' : ''}>${TYPE_MAP[key]}</option>`).join('');
            const subjectOptions = SUBJECTS.map(s => `<option value="${s}" ${s === item.subjectName ? 'selected' : ''}>${s}</option>`).join('');
            
            // NEW: Priority options
            const priorityOptions = Object.keys(PRIORITY_MAP).map(key => `<option value="${key}" ${key === item.priority ? 'selected' : ''}>${PRIORITY_MAP[key].text}</option>`).join('');

            document.getElementById('modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">${item.isNew ? 'إضافة متطلب جديد' : 'تعديل المتطلب'}</h2>
                <form id="requirement-form" class="max-h-[80vh] overflow-y-auto p-1" onsubmit="event.preventDefault(); saveRequirement(this, '${item.id || ''}', ${item.isNew}, '${item.created_at || ''}')">

                    <label for="modal-subject" class="block text-sm font-medium mb-1 mt-3">المادة</label>
                    <select id="modal-subject" name="subjectName" required class="w-full p-3 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);">${subjectOptions}</select>

                    <label for="modal-title" class="block text-sm font-medium mb-1 mt-3">العنوان</label>
                    <input type="text" id="modal-title" name="title" value="${item.title || ''}" required class="w-full p-3 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);" />

                    <label for="modal-description" class="block text-sm font-medium mb-1 mt-3">الوصف</label>
                    <textarea id="modal-description" name="description" rows="3" required class="w-full p-3 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);">${item.description || ''}</textarea>

                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label for="modal-type" class="block text-sm font-medium mb-1 mt-3">النوع</label>
                            <select id="modal-type" name="type" required class="w-full p-3 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);">${typeOptions}</select>
                        </div>
                        <div class="flex-1">
                            <label for="modal-date" class="block text-sm font-medium mb-1 mt-3">تاريخ الاستحقاق</label>
                            <input type="date" id="modal-date" name="due_date" value="${item.due_date || ''}" class="w-full p-3 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);" />
                        </div>
                        <!-- NEW: Priority -->
                        <div class="flex-1">
                            <label for="modal-priority" class="block text-sm font-medium mb-1 mt-3">الأولوية</label>
                            <select id="modal-priority" name="priority" required class="w-full p-3 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);">${priorityOptions}</select>
                        </div>
                    </div>
                    
                    <!-- NEW: Subtask Editor -->
                    <label class="block text-sm font-medium mb-1 mt-4">المهام الفرعية (اختياري)</label>
                    <div class="p-3 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);">
                        ${renderSubtaskEditor(item.subtasks)}
                    </div>
                    
                    <label for="modal-file-display-name" class="block text-sm font-medium mb-1 mt-4">اسم الملف المعروض</label>
                    <input type="text" id="modal-file-display-name" name="file_display_name" value="${item.file_display_name || ''}" placeholder="اسم الرابط الذي سيظهر للطالب" class="w-full p-3 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);" />

                    <label for="modal-link" class="block text-sm font-medium mb-1 mt-3">رابط خارجي (ملف/صورة/موقع)</label>
                    <textarea id="modal-link" name="fileLink" rows="2" oninput="updateFilePreview()" placeholder="https://..." class="w-full p-3 rounded-lg border" style="background-color: var(--bg-color); border-color: var(--card-border);">${item.file || ''}</textarea>
                    <div class="flex justify-between items-center">
                        <div id="link-preview" class="mt-1 h-4 flex items-center"></div>
                        <a href="https://imgbb.com/" target="_blank" class="text-xs font-medium text-primary-500 hover:underline">لرفع الصور: استخدم ImgBB</a>
                    </div>

                    <div class="mt-4 flex items-center justify-end">
                        <label for="modal-pinned" class="mr-2 text-sm font-medium">تثبيت العنصر (يعرض في الأعلى)</label>
                        <input type="checkbox" id="modal-pinned" name="pinned" ${item.pinned ? 'checked' : ''} class="w-4 h-4 text-primary-600 rounded border-gray-600 focus:ring-primary-500">
                    </div>

                    <div class="mt-6 flex justify-start space-x-3 space-x-reverse pt-4 border-t" style="border-color: var(--card-border);">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إلغاء</button>
                        <button type="submit" id="save-button" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-primary-600 hover:bg-primary-700 transition-colors">حفظ</button>
                    </div>
                </form>
            `;
            // NEW: Use larger modal for this form
            document.getElementById('modal-content').classList.remove('max-w-md');
            document.getElementById('modal-content').classList.add('max-w-xl');
            showModal();
            updateFilePreview();
        }

        window.saveRequirement = async function(formElement, itemId, isNew, existingCreatedAt) {
            if (!isAdmin) return;
            const saveButton = formElement.querySelector('#save-button');
            if (saveButton) { saveButton.disabled = true; saveButton.textContent = 'جاري الحفظ...'; }
            
            const formData = new FormData(formElement);
            let newItem = Object.fromEntries(formData.entries());
            newItem.pinned = !!newItem.pinned;
            newItem.file = newItem.fileLink;
            delete newItem.fileLink;
            
            // NEW: Get subtasks
            newItem.subtasks = getSubtasksFromEditor();

            newItem = cleanItemData(newItem);
            const finalItemId = isNew ? crypto.randomUUID() : itemId;
            newItem.id = finalItemId;
            newItem.created_at = isNew ? new Date().toISOString() : (existingCreatedAt || new Date().toISOString());

            const currentSubjectName = formData.get('subjectName');
            const updatedSubjects = JSON.parse(JSON.stringify(currentData.subjects));
            
            if (isNew) {
                updatedSubjects[currentSubjectName] = updatedSubjects[currentSubjectName] || [];
                updatedSubjects[currentSubjectName].push(newItem);
            } else {
                let itemFound = false;
                for (const subj of SUBJECTS) {
                    const index = updatedSubjects[subj].findIndex(item => item.id === finalItemId);
                    if (index !== -1) {
                        if (subj === currentSubjectName) {
                            updatedSubjects[subj][index] = newItem;
                        } else {
                            updatedSubjects[subj].splice(index, 1);
                            updatedSubjects[currentSubjectName].push(newItem);
                        }
                        itemFound = true;
                        break;
                    }
                }
                if (!itemFound) updatedSubjects[currentSubjectName].push(newItem);
            }
            
            updateData({ ...currentData, subjects: updatedSubjects });
            showNotification(isNew ? "تمت إضافة المتطلب." : "تم تحديث المتطلب.", "success");
            closeModal(); 
            
            setTimeout(() => {
                const targetElement = document.getElementById(`card-${finalItemId}`);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    targetElement.style.transition = 'box-shadow 0.3s';
                    targetElement.style.boxShadow = '0 0 20px 5px var(--color-primary-500)';
                    setTimeout(() => targetElement.style.boxShadow = '', 1500);
                }
            }, 350); 
        };
        
        // --- NEW: Multi-Select Logic ---
        window.toggleSelectMode = function() {
            if (!isAdmin) return;
            isSelectMode = !isSelectMode;
            selectedItems.clear();
            
            const btn = document.getElementById('admin-select-toggle');
            const bar = document.getElementById('multi-delete-bar');
            
            if (isSelectMode) {
                btn.innerHTML = '<i class="ph ph-x-circle ml-2"></i> إلغاء التحديد';
                btn.classList.replace('bg-blue-600', 'bg-yellow-600');
                bar.classList.add('visible');
            } else {
                btn.innerHTML = '<i class="ph ph-check-square-offset ml-2"></i> تفعيل وضع التحديد';
                btn.classList.replace('bg-yellow-600', 'bg-blue-600');
                bar.classList.remove('visible');
            }
            updateSelectionCount();
            renderApp(); // Re-render to show/hide checkboxes
        }
        
        window.toggleItemSelection = function(itemId) {
            if (!isSelectMode) return;
            if (selectedItems.has(itemId)) {
                selectedItems.delete(itemId);
            } else {
                selectedItems.add(itemId);
            }
            
            // Update card UI
            const card = document.getElementById(`card-${itemId}`);
            if (card) {
                card.classList.toggle('selected', selectedItems.has(itemId));
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = selectedItems.has(itemId);
            }
            updateSelectionCount();
        }
        
        function updateSelectionCount() {
            document.getElementById('selection-count').textContent = `تم تحديد ${selectedItems.size} عنصر`;
        }
        
        window.deleteSelectedItems = function() {
            if (!isAdmin || selectedItems.size === 0) return;
            
            const actionString = `performConfirmedMultiDeletion()`;
            showInfoModal(
                'تأكيد الحذف المتعدد',
                `هل أنت متأكد من حذف **${selectedItems.size}** عنصر؟ لا يمكن التراجع عن هذا الإجراء.`,
                actionString,
                'نعم، احذف المحدد',
                true
            );
        }
        
        window.performConfirmedMultiDeletion = function() {
            if (!isAdmin) return;
            
            let updatedSubjects = JSON.parse(JSON.stringify(currentData.subjects));
            let deletedCount = 0;
            
            selectedItems.forEach(itemId => {
                // Animate deletion
                const card = document.getElementById(`card-${itemId}`);
                if (card) card.classList.add('deleting');
                
                // Find and remove from data
                for (const subj of SUBJECTS) {
                    const index = updatedSubjects[subj].findIndex(item => item.id === itemId);
                    if (index !== -1) {
                        updatedSubjects[subj].splice(index, 1);
                        deletedCount++;
                        break;
                    }
                }
            });
            
            setTimeout(() => {
                updateData({ ...currentData, subjects: updatedSubjects });
                showNotification(`تم حذف ${deletedCount} عناصر بنجاح.`, "info");
                toggleSelectMode(); // Exit select mode
            }, 350);
        }
        
        // --- Deletion Logic (Single) ---
        async function performConfirmedDeletion(subjectName, itemId) {
            if (!isAdmin) return;
            const card = document.getElementById(`card-${itemId}`);
            if (card) card.classList.add('deleting');
            closeModal();
            
            setTimeout(() => {
                const updatedSubjects = JSON.parse(JSON.stringify(currentData.subjects));
                let deletedItemTitle = "متطلب";
                
                for (const subj of SUBJECTS) {
                    const index = updatedSubjects[subj].findIndex(item => item.id === itemId);
                    if (index !== -1) {
                        deletedItemTitle = updatedSubjects[subj][index].title;
                        updatedSubjects[subj].splice(index, 1);
                        updateData({ ...currentData, subjects: updatedSubjects });
                        showNotification(`تم حذف المتطلب: ${deletedItemTitle}.`, 'info');
                        return;
                    }
                }
                showNotification("فشل الحذف. لم يتم العثور على المتطلب.", 'error');
            }, 350);
        }

        window.deleteRequirement = function(subjectName, itemId, shouldConfirm = false) {
            if (shouldConfirm) {
                const item = findItem(itemId)?.item;
                if (!item) {
                     showNotification("لا يمكن الحذف: المتطلب غير موجود.", 'error');
                     return;
                }
                const actionString = `performConfirmedDeletion('${subjectName.replace(/'/g, "\\'")}', '${itemId.replace(/'/g, "\\'")}')`;
                showInfoModal('تأكيد الحذف', `هل أنت متأكد من حذف: **${item.title}**؟`, actionString, 'نعم، احذف', true);
            } else {
                performConfirmedDeletion(subjectName, itemId);
            }
        };

        function showInfoModal(title, message, confirmAction = null, confirmText = 'OK', isDestructive = false) {
            const content = document.getElementById('modal-content');
            const confirmClass = isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-primary-600 hover:bg-primary-700';
            
            let buttons = confirmAction ? `
                <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg text-sm transition-colors hover:bg-gray-700">إلغاء</button>
                <button type="button" onclick="${confirmAction}" class="px-4 py-2 rounded-lg text-sm font-semibold text-white ${confirmClass} transition-colors">${confirmText}</button>
            ` : `
                <button onclick="closeModal()" class="w-full px-4 py-2 rounded-lg text-sm font-semibold text-white ${confirmClass} transition-colors">${confirmText}</button>
            `;

            content.innerHTML = `
                <h2 class="text-xl font-bold mb-4">${title}</h2>
                <p class="mb-6 text-sm opacity-90">${message.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>')}</p>
                <div class="flex justify-start space-x-3 space-x-reverse">${buttons}</div>
            `;
            showModal();
        }

        // --- ANTI-INSPECT / DEV TOOLS LOCK ---
        function isDevLockEnabled() {
            // Check localStorage or default to true if never set (for new users)
            return localStorage.getItem(DEV_LOCK_KEY) !== 'false';
        }
        
        function initDevToolsLock() {
            const overlay = document.getElementById('anti-inspect-overlay');

            const checkDevTools = () => {
                if (!isDevLockEnabled()) {
                    overlay.style.display = 'none';
                    return;
                }
                
                // Heuristic 1: Window size difference (works for docked tools)
                const widthThreshold = window.outerWidth - window.innerWidth > 160;
                const heightThreshold = window.outerHeight - window.innerHeight > 160;
                
                // Check if DevTools is considered open
                const devToolsOpen = widthThreshold || heightThreshold;

                if (devToolsOpen) {
                    overlay.style.display = 'flex';
                    // Repeatedly call debugger to trap the user
                    // Using setTimeout avoids hard-crashing certain browsers
                    setTimeout(() => { debugger; }, 50); 
                } else {
                    overlay.style.display = 'none';
                }
            };
            
            // 1. Initial/Interval/Resize Check (Heuristic 1) - Check faster (every 500ms)
            setInterval(checkDevTools, 500); 
            window.addEventListener('resize', checkDevTools);
            checkDevTools(); // Initial check

            // 2. Keyboard Shortcut Blocking (Annoyance)
            window.addEventListener('keydown', (e) => {
                if (!isDevLockEnabled()) return;
                
                // F12 key (e.key === 'F12' in modern browsers)
                // Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C (common shortcuts)
                const isShortcut = e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C'));

                if (isShortcut) {
                    e.preventDefault();
                    overlay.style.display = 'flex';
                    setTimeout(() => { debugger; }, 50); // Trigger debugger on block
                }
            }, true); // Use capturing phase for higher priority

            // 3. Right-Click Context Menu Blocking (Annoyance)
            window.addEventListener('contextmenu', (e) => {
                if (!isDevLockEnabled()) return;
                e.preventDefault();
                overlay.style.display = 'flex';
                setTimeout(() => { debugger; }, 50); // Trigger debugger on block
            });
        }

        // --- ENTRY POINT ---
        window.onload = function() {
            initDevToolsLock();
            initApp();
        };
    </script>
</body>
</html>
